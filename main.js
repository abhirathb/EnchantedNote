/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Ct=Object.defineProperty;var _r=Object.getOwnPropertyDescriptor;var Sr=Object.getOwnPropertyNames;var xr=Object.prototype.hasOwnProperty;var Er=(r,e)=>{for(var t in e)Ct(r,t,{get:e[t],enumerable:!0})},Mr=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Sr(e))!xr.call(r,s)&&s!==t&&Ct(r,s,{get:()=>e[s],enumerable:!(n=_r(e,s))||n.enumerable});return r};var kr=r=>Mr(Ct({},"__esModule",{value:!0}),r);var us={};Er(us,{default:()=>Rt});module.exports=kr(us);var br=require("obsidian"),wr=require("@codemirror/view");var Nt={apiKey:"",model:"claude-sonnet-4-20250514",defaultStyle:"muse",defaultMood:"auto",pauseDuration:2,enableLinkedNoteContext:!1,linkedNoteDepth:1,showDeveloperPanel:!1};var k=require("obsidian"),qe=class extends k.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"API Configuration"}),new k.Setting(e).setName("Claude API Key").setDesc("Your Anthropic API key. Get one at console.anthropic.com").addText(n=>n.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s,await this.plugin.saveSettings(),this.plugin.updateApiKey(s)})),new k.Setting(e).setName("Model").setDesc("The Claude model to use for responses").addDropdown(n=>n.addOption("claude-sonnet-4-20250514","Claude Sonnet 4 (Recommended)").addOption("claude-opus-4-20250514","Claude Opus 4").addOption("claude-3-5-sonnet-20241022","Claude 3.5 Sonnet").addOption("claude-3-5-haiku-20241022","Claude 3.5 Haiku (Faster)").setValue(this.plugin.settings.model).onChange(async s=>{this.plugin.settings.model=s,await this.plugin.saveSettings(),this.plugin.updateModel(s)})),e.createEl("h2",{text:"Behavior"}),new k.Setting(e).setName("Default interaction style").setDesc("How Claude responds by default").addDropdown(n=>n.addOption("muse","Muse (inline responses)").addOption("whisper","Whisper (margin annotations)").addOption("off","Off").setValue(this.plugin.settings.defaultStyle).onChange(async s=>{this.plugin.settings.defaultStyle=s,await this.plugin.saveSettings()})),new k.Setting(e).setName("Default mood").setDesc("The default persona for Claude's responses").addDropdown(n=>n.addOption("auto","Auto-detect").addOption("reflect","Reflect (journaling)").addOption("think","Think (essays/ideas)").addOption("plan","Plan (todos/planning)").setValue(this.plugin.settings.defaultMood).onChange(async s=>{this.plugin.settings.defaultMood=s,await this.plugin.saveSettings()})),new k.Setting(e).setName("Pause duration").setDesc("How long to wait after typing stops before Muse responds (seconds)").addSlider(n=>n.setLimits(1,5,.5).setValue(this.plugin.settings.pauseDuration).setDynamicTooltip().onChange(async s=>{this.plugin.settings.pauseDuration=s,await this.plugin.saveSettings(),this.plugin.updatePauseDuration(s)})),new k.Setting(e).setName("Enable linked note context").setDesc("Include content from linked notes in Claude's context").addToggle(n=>n.setValue(this.plugin.settings.enableLinkedNoteContext).onChange(async s=>{this.plugin.settings.enableLinkedNoteContext=s,await this.plugin.saveSettings()})),new k.Setting(e).setName("Linked note depth").setDesc("How many levels of links to include (if linked note context is enabled)").addDropdown(n=>n.addOption("1","1 level").addOption("2","2 levels").addOption("3","3 levels").setValue(this.plugin.settings.linkedNoteDepth.toString()).onChange(async s=>{this.plugin.settings.linkedNoteDepth=parseInt(s),await this.plugin.saveSettings()})),e.createEl("h2",{text:"Keyboard Shortcuts"}),e.createEl("p",{text:"Default shortcuts:",cls:"setting-item-description"});let t=e.createEl("ul",{cls:"setting-item-description"});if(t.createEl("li",{text:"Cmd/Ctrl + Shift + M: Toggle Muse mode"}),t.createEl("li",{text:"Cmd/Ctrl + Shift + W: Toggle Whisper mode"}),new k.Setting(e).setName("Customize shortcuts").setDesc("Open Obsidian's hotkey settings to customize shortcuts").addButton(n=>n.setButtonText("Open Hotkey Settings").onClick(()=>{this.app.setting.openTabById("hotkeys"),this.app.setting.activeTab.searchComponent.inputEl.value="Enchanted Notes",this.app.setting.activeTab.updateHotkeyVisibility()})),e.createEl("h2",{text:"Developer"}),new k.Setting(e).setName("Show developer panel").setDesc("Display token usage and response times").addToggle(n=>n.setValue(this.plugin.settings.showDeveloperPanel).onChange(async s=>{this.plugin.settings.showDeveloperPanel=s,await this.plugin.saveSettings()})),this.plugin.settings.showDeveloperPanel){let n=this.plugin.getStats(),s=e.createDiv({cls:"enchanted-notes-stats"});s.createEl("p",{text:`Tokens this session: ${n.tokensThisSession}`}),s.createEl("p",{text:`Tokens today: ${n.tokensToday}`}),s.createEl("p",{text:`Last response time: ${n.lastResponseTime}ms`}),s.createEl("p",{text:`Current context size: ${n.currentContextSize} chars`}),new k.Setting(e).setName("Reset session stats").addButton(i=>i.setButtonText("Reset").onClick(()=>{this.plugin.resetSessionStats(),this.display()}))}e.createEl("h2",{text:"About"}),e.createEl("p",{text:"Enchanted Notes makes your notes come alive. Write naturally, and Claude will respond as your thinking partner.",cls:"setting-item-description"}),e.createEl("p",{text:"Use ::muse[...]:: or :::muse blocks for inline responses, and ::whisper[...]:: for margin annotations.",cls:"setting-item-description"})}};function h(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t}function l(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)}var It=function(){let{crypto:r}=globalThis;if(r!=null&&r.randomUUID)return It=r.randomUUID.bind(r),r.randomUUID();let e=new Uint8Array(1),t=r?()=>r.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,n=>(+n^t()&15>>+n/4).toString(16))};function B(r){return typeof r=="object"&&r!==null&&("name"in r&&r.name==="AbortError"||"message"in r&&String(r.message).includes("FetchRequestCanceledException"))}var Me=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null){try{if(Object.prototype.toString.call(r)==="[object Error]"){let e=new Error(r.message,r.cause?{cause:r.cause}:{});return r.stack&&(e.stack=r.stack),r.cause&&!e.cause&&(e.cause=r.cause),r.name&&(e.name=r.name),e}}catch(e){}try{return new Error(JSON.stringify(r))}catch(e){}}return new Error(r)};var d=class extends Error{},S=class r extends d{constructor(e,t,n,s){super(`${r.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.requestID=s==null?void 0:s.get("request-id"),this.error=t}static makeMessage(e,t,n){let s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new q({message:n,cause:Me(t)});let i=t;return e===400?new ae(e,i,n,s):e===401?new le(e,i,n,s):e===403?new ce(e,i,n,s):e===404?new ue(e,i,n,s):e===409?new de(e,i,n,s):e===422?new he(e,i,n,s):e===429?new fe(e,i,n,s):e>=500?new pe(e,i,n,s):new r(e,i,n,s)}},x=class extends S{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},q=class extends S{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},oe=class extends q{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},ae=class extends S{},le=class extends S{},ce=class extends S{},ue=class extends S{},de=class extends S{},he=class extends S{},fe=class extends S{},pe=class extends S{};var Tr=/^[a-z][a-z0-9+.-]*:/i,_n=r=>Tr.test(r);function Ot(r){return typeof r!="object"?{}:r!=null?r:{}}function Sn(r){if(!r)return!0;for(let e in r)return!1;return!0}function xn(r,e){return Object.prototype.hasOwnProperty.call(r,e)}var En=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new d(`${r} must be an integer`);if(e<0)throw new d(`${r} must be a positive integer`);return e};var ze=r=>{try{return JSON.parse(r)}catch(e){return}};var Mn=r=>new Promise(e=>setTimeout(e,r));var Xe={off:0,error:200,warn:300,info:400,debug:500},Dt=(r,e,t)=>{if(r){if(xn(Xe,r))return r;E(t).warn(`${e} was set to ${JSON.stringify(r)}, expected one of ${JSON.stringify(Object.keys(Xe))}`)}};function ke(){}function Ke(r,e,t){return!e||Xe[r]>Xe[t]?ke:e[r].bind(e)}var vr={error:ke,warn:ke,info:ke,debug:ke},kn=new WeakMap;function E(r){var i;let e=r.logger,t=(i=r.logLevel)!=null?i:"off";if(!e)return vr;let n=kn.get(e);if(n&&n[0]===t)return n[1];let s={error:Ke("error",e,t),warn:Ke("warn",e,t),info:Ke("info",e,t),debug:Ke("debug",e,t)};return kn.set(e,[t,s]),s}var $=r=>(r.options&&(r.options={...r.options},delete r.options.headers),r.headers&&(r.headers=Object.fromEntries((r.headers instanceof Headers?[...r.headers]:Object.entries(r.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in r&&(r.retryOfRequestLogID&&(r.retryOf=r.retryOfRequestLogID),delete r.retryOfRequestLogID),r);var z="0.52.0";var vn=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined";function Ar(){return typeof Deno!="undefined"&&Deno.build!=null?"deno":typeof EdgeRuntime!="undefined"?"edge":Object.prototype.toString.call(typeof globalThis.process!="undefined"?globalThis.process:0)==="[object process]"?"node":"unknown"}var Rr=()=>{var t,n;let r=Ar();if(r==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":z,"X-Stainless-OS":Tn(Deno.build.os),"X-Stainless-Arch":Pn(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(n=(t=Deno.version)==null?void 0:t.deno)!=null?n:"unknown"};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":z,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(r==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":z,"X-Stainless-OS":Tn(globalThis.process.platform),"X-Stainless-Arch":Pn(globalThis.process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version};let e=Cr();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":z,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":z,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Cr(){if(typeof navigator=="undefined"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let n=t.exec(navigator.userAgent);if(n){let s=n[1]||0,i=n[2]||0,o=n[3]||0;return{browser:e,version:`${s}.${i}.${o}`}}}return null}var Pn=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",Tn=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),Je,An=()=>Je!=null?Je:Je=Rr();function Rn(){if(typeof fetch!="undefined")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Lt(...r){let e=globalThis.ReadableStream;if(typeof e=="undefined")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...r)}function Ge(r){let e=Symbol.asyncIterator in r?r[Symbol.asyncIterator]():r[Symbol.iterator]();return Lt({start(){},async pull(t){let{done:n,value:s}=await e.next();n?t.close():t.enqueue(s)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function Pe(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function Cn(r){var n,s;if(r===null||typeof r!="object")return;if(r[Symbol.asyncIterator]){await((s=(n=r[Symbol.asyncIterator]()).return)==null?void 0:s.call(n));return}let e=r.getReader(),t=e.cancel();e.releaseLock(),await t}var Nn=({headers:r,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});function In(r){let e=0;for(let s of r)e+=s.length;let t=new Uint8Array(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return t}var Ye;function Te(r){let e;return(Ye!=null?Ye:(e=new globalThis.TextEncoder,Ye=e.encode.bind(e)))(r)}var Qe;function Ft(r){let e;return(Qe!=null?Qe:(e=new globalThis.TextDecoder,Qe=e.decode.bind(e)))(r)}var P,T,U=class{constructor(){P.set(this,void 0),T.set(this,void 0),h(this,P,new Uint8Array,"f"),h(this,T,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Te(e):e;h(this,P,In([l(this,P,"f"),t]),"f");let n=[],s;for(;(s=Or(l(this,P,"f"),l(this,T,"f")))!=null;){if(s.carriage&&l(this,T,"f")==null){h(this,T,s.index,"f");continue}if(l(this,T,"f")!=null&&(s.index!==l(this,T,"f")+1||s.carriage)){n.push(Ft(l(this,P,"f").subarray(0,l(this,T,"f")-1))),h(this,P,l(this,P,"f").subarray(l(this,T,"f")),"f"),h(this,T,null,"f");continue}let i=l(this,T,"f")!==null?s.preceding-1:s.preceding,o=Ft(l(this,P,"f").subarray(0,i));n.push(o),h(this,P,l(this,P,"f").subarray(s.index),"f"),h(this,T,null,"f")}return n}flush(){return l(this,P,"f").length?this.decode(`
`):[]}};P=new WeakMap,T=new WeakMap;U.NEWLINE_CHARS=new Set([`
`,"\r"]);U.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Or(r,e){for(let s=e!=null?e:0;s<r.length;s++){if(r[s]===10)return{preceding:s,index:s+1,carriage:!1};if(r[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function On(r){for(let n=0;n<r.length-1;n++){if(r[n]===10&&r[n+1]===10||r[n]===13&&r[n+1]===13)return n+2;if(r[n]===13&&r[n+1]===10&&n+3<r.length&&r[n+2]===13&&r[n+3]===10)return n+4}return-1}var O=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*s(){var o;if(n)throw new d("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(let a of Dr(e,t)){if(a.event==="completion")try{yield JSON.parse(a.data)}catch(c){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),c}if(a.event==="message_start"||a.event==="message_delta"||a.event==="message_stop"||a.event==="content_block_start"||a.event==="content_block_delta"||a.event==="content_block_stop")try{yield JSON.parse(a.data)}catch(c){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),c}if(a.event!=="ping"&&a.event==="error")throw new S(void 0,(o=ze(a.data))!=null?o:a.data,void 0,e.headers)}i=!0}catch(a){if(B(a))return;throw a}finally{i||t.abort()}}return new r(s,t)}static fromReadableStream(e,t){let n=!1;async function*s(){let o=new U,a=Pe(e);for await(let c of a)for(let u of o.decode(c))yield u;for(let c of o.flush())yield c}async function*i(){if(n)throw new d("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let o=!1;try{for await(let a of s())o||a&&(yield JSON.parse(a));o=!0}catch(a){if(B(a))return;throw a}finally{o||t.abort()}}return new r(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],n=this.iterator(),s=i=>({next:()=>{if(i.length===0){let o=n.next();e.push(o),t.push(o)}return i.shift()}});return[new r(()=>s(e),this.controller),new r(()=>s(t),this.controller)]}toReadableStream(){let e=this,t;return Lt({async start(){t=e[Symbol.asyncIterator]()},async pull(n){try{let{value:s,done:i}=await t.next();if(i)return n.close();let o=Te(JSON.stringify(s)+`
`);n.enqueue(o)}catch(s){n.error(s)}},async cancel(){var n;await((n=t.return)==null?void 0:n.call(t))}})}};async function*Dr(r,e){if(!r.body)throw e.abort(),typeof globalThis.navigator!="undefined"&&globalThis.navigator.product==="ReactNative"?new d("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new d("Attempted to iterate over a response with no body");let t=new Wt,n=new U,s=Pe(r.body);for await(let i of Lr(s))for(let o of n.decode(i)){let a=t.decode(o);a&&(yield a)}for(let i of n.flush()){let o=t.decode(i);o&&(yield o)}}async function*Lr(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Te(t):t,s=new Uint8Array(e.length+n.length);s.set(e),s.set(n,e.length),e=s;let i;for(;(i=On(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var Wt=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=Fr(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}};function Fr(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}async function Ze(r,e){let{response:t,requestLogID:n,retryOfRequestLogID:s,startTime:i}=e,o=await(async()=>{var m;if(e.options.stream)return E(r).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):O.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let a=t.headers.get("content-type"),c=(m=a==null?void 0:a.split(";")[0])==null?void 0:m.trim();if((c==null?void 0:c.includes("application/json"))||(c==null?void 0:c.endsWith("+json"))){let b=await t.json();return Bt(b,t)}return await t.text()})();return E(r).debug(`[${n}] response parsed`,$({retryOfRequestLogID:s,url:t.url,status:t.status,body:o,durationMs:Date.now()-i})),o}function Bt(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var ve,Z=class r extends Promise{constructor(e,t,n=Ze){super(s=>{s(null)}),this.responsePromise=t,this.parseResponse=n,ve.set(this,void 0),h(this,ve,e,"f")}_thenUnwrap(e){return new r(l(this,ve,"f"),this.responsePromise,async(t,n)=>Bt(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(l(this,ve,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};ve=new WeakMap;var et,$t=class{constructor(e,t,n,s){et.set(this,void 0),h(this,et,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new d("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await l(this,et,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(et=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Ae=class extends Z{constructor(e,t,n){super(e,t,async(s,i)=>new n(s,i.response,await Ze(s,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},A=class extends $t{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1,this.first_id=n.first_id||null,this.last_id=n.last_id||null}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var t;if((t=this.options.query)!=null&&t.before_id){let n=this.first_id;return n?{...this.options,query:{...Ot(this.options.query),before_id:n}}:null}let e=this.last_id;return e?{...this.options,query:{...Ot(this.options.query),after_id:e}}:null}};var jt=()=>{var r;if(typeof File=="undefined"){let{process:e}=globalThis,t=typeof((r=e==null?void 0:e.versions)==null?void 0:r.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function ee(r,e,t){return jt(),new File(r,e!=null?e:"unknown_file",t)}function Re(r){return(typeof r=="object"&&r!==null&&("name"in r&&r.name&&String(r.name)||"url"in r&&r.url&&String(r.url)||"filename"in r&&r.filename&&String(r.filename)||"path"in r&&r.path&&String(r.path))||"").split(/[\\/]/).pop()||void 0}var Ht=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function";var Ln=async(r,e)=>({...r,body:await $r(r.body,e)}),Dn=new WeakMap;function Br(r){let e=typeof r=="function"?r:r.fetch,t=Dn.get(e);if(t)return t;let n=(async()=>{try{let s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch(s){return!0}})();return Dn.set(e,n),n}var $r=async(r,e)=>{if(!await Br(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(r||{}).map(([n,s])=>Ut(t,n,s))),t},Ur=r=>r instanceof Blob&&"name"in r;var Ut=async(r,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")r.append(e,String(t));else if(t instanceof Response){let n={},s=t.headers.get("Content-Type");s&&(n={type:s}),r.append(e,ee([await t.blob()],Re(t),n))}else if(Ht(t))r.append(e,ee([await new Response(Ge(t)).blob()],Re(t)));else if(Ur(t))r.append(e,ee([t],Re(t),{type:t.type}));else if(Array.isArray(t))await Promise.all(t.map(n=>Ut(r,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,s])=>Ut(r,`${e}[${n}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Fn=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function",jr=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&Fn(r),Hr=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function";async function tt(r,e,t){if(jt(),r=await r,e||(e=Re(r)),jr(r))return r instanceof File&&e==null&&t==null?r:ee([await r.arrayBuffer()],e!=null?e:r.name,{type:r.type,lastModified:r.lastModified,...t});if(Hr(r)){let s=await r.blob();return e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()),ee(await Vt(s),e,t)}let n=await Vt(r);if(!(t!=null&&t.type)){let s=n.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(t={...t,type:s})}return ee(n,e,t)}async function Vt(r){var t;let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(Fn(r))e.push(r instanceof Blob?r:await r.arrayBuffer());else if(Ht(r))for await(let n of r)e.push(...await Vt(n));else{let n=(t=r==null?void 0:r.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof r}${n?`; constructor: ${n}`:""}${Vr(r)}`)}return e}function Vr(r){return typeof r!="object"||r===null?"":`; props: [${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}var _=class{constructor(e){this._client=e}};var Bn=Symbol.for("brand.privateNullableHeaders"),Wn=Array.isArray;function*zr(r){if(!r)return;if(Bn in r){let{values:n,nulls:s}=r;yield*n.entries();for(let i of s)yield[i,null];return}let e=!1,t;r instanceof Headers?t=r.entries():Wn(r)?t=r:(e=!0,t=Object.entries(r!=null?r:{}));for(let n of t){let s=n[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");let i=Wn(n[1])?n[1]:[n[1]],o=!1;for(let a of i)a!==void 0&&(e&&!o&&(o=!0,yield[s,null]),yield[s,a])}}var g=r=>{let e=new Headers,t=new Set;for(let n of r){let s=new Set;for(let[i,o]of zr(n)){let a=i.toLowerCase();s.has(a)||(e.delete(i),s.add(a)),o===null?(e.delete(i),t.add(a)):(e.append(i,o),t.delete(a))}}return{[Bn]:!0,values:e,nulls:t}};function $n(r){return r.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var Kr=(r=$n)=>function(t,...n){if(t.length===1)return t[0];let s=!1,i=t.reduce((p,m,b)=>(/[?#]/.test(m)&&(s=!0),p+m+(b===n.length?"":(s?encodeURIComponent:r)(String(n[b])))),""),o=i.split(/[?#]/,1)[0],a=[],c=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,u;for(;(u=c.exec(o))!==null;)a.push({start:u.index,length:u[0].length});if(a.length>0){let p=0,m=a.reduce((b,f)=>{let w=" ".repeat(f.start-p),Q="^".repeat(f.length);return p=f.start+f.length,b+w+Q},"");throw new d(`Path parameters result in path with invalid segments:
${i}
${m}`)}return i},M=Kr($n);var me=class extends _{list(e={},t){let{betas:n,...s}=e!=null?e:{};return this._client.getAPIList("/v1/files",A,{query:s,...t,headers:g([{"anthropic-beta":[...n!=null?n:[],"files-api-2025-04-14"].toString()},t==null?void 0:t.headers])})}delete(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.delete(M`/v1/files/${e}`,{...n,headers:g([{"anthropic-beta":[...s!=null?s:[],"files-api-2025-04-14"].toString()},n==null?void 0:n.headers])})}download(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.get(M`/v1/files/${e}/content`,{...n,headers:g([{"anthropic-beta":[...s!=null?s:[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},n==null?void 0:n.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.get(M`/v1/files/${e}`,{...n,headers:g([{"anthropic-beta":[...s!=null?s:[],"files-api-2025-04-14"].toString()},n==null?void 0:n.headers])})}upload(e,t){let{betas:n,...s}=e;return this._client.post("/v1/files",Ln({body:s,...t,headers:g([{"anthropic-beta":[...n!=null?n:[],"files-api-2025-04-14"].toString()},t==null?void 0:t.headers])},this._client))}};var ge=class extends _{retrieve(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.get(M`/v1/models/${e}?beta=true`,{...n,headers:g([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},n==null?void 0:n.headers])})}list(e={},t){let{betas:n,...s}=e!=null?e:{};return this._client.getAPIList("/v1/models?beta=true",A,{query:s,...t,headers:g([{...(n==null?void 0:n.toString())!=null?{"anthropic-beta":n==null?void 0:n.toString()}:void 0},t==null?void 0:t.headers])})}};var ye=class r{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new U;for await(let t of this.iterator)for(let n of e.decode(t))yield JSON.parse(n);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator!="undefined"&&globalThis.navigator.product==="ReactNative"?new d("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new d("Attempted to iterate over a response with no body");return new r(Pe(e.body),t)}};var be=class extends _{create(e,t){let{betas:n,...s}=e;return this._client.post("/v1/messages/batches?beta=true",{body:s,...t,headers:g([{"anthropic-beta":[...n!=null?n:[],"message-batches-2024-09-24"].toString()},t==null?void 0:t.headers])})}retrieve(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.get(M`/v1/messages/batches/${e}?beta=true`,{...n,headers:g([{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString()},n==null?void 0:n.headers])})}list(e={},t){let{betas:n,...s}=e!=null?e:{};return this._client.getAPIList("/v1/messages/batches?beta=true",A,{query:s,...t,headers:g([{"anthropic-beta":[...n!=null?n:[],"message-batches-2024-09-24"].toString()},t==null?void 0:t.headers])})}delete(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.delete(M`/v1/messages/batches/${e}?beta=true`,{...n,headers:g([{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString()},n==null?void 0:n.headers])})}cancel(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.post(M`/v1/messages/batches/${e}/cancel?beta=true`,{...n,headers:g([{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString()},n==null?void 0:n.headers])})}async results(e,t={},n){let s=await this.retrieve(e);if(!s.results_url)throw new d(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);let{betas:i}=t!=null?t:{};return this._client.get(s.results_url,{...n,headers:g([{"anthropic-beta":[...i!=null?i:[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},n==null?void 0:n.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((o,a)=>ye.fromResponse(a.response,a.controller))}};var Yr=r=>{let e=0,t=[];for(;e<r.length;){let n=r[e];if(n==="\\"){e++;continue}if(n==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(n==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(n==="["){t.push({type:"paren",value:"["}),e++;continue}if(n==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(n===":"){t.push({type:"separator",value:":"}),e++;continue}if(n===","){t.push({type:"delimiter",value:","}),e++;continue}if(n==='"'){let a="",c=!1;for(n=r[++e];n!=='"';){if(e===r.length){c=!0;break}if(n==="\\"){if(e++,e===r.length){c=!0;break}a+=n+r[e],n=r[++e]}else a+=n,n=r[++e]}n=r[++e],c||t.push({type:"string",value:a});continue}if(n&&/\s/.test(n)){e++;continue}let i=/[0-9]/;if(n&&i.test(n)||n==="-"||n==="."){let a="";for(n==="-"&&(a+=n,n=r[++e]);n&&i.test(n)||n===".";)a+=n,n=r[++e];t.push({type:"number",value:a});continue}let o=/[a-z]/i;if(n&&o.test(n)){let a="";for(;n&&o.test(n)&&e!==r.length;)a+=n,n=r[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},we=r=>{if(r.length===0)return r;let e=r[r.length-1];switch(e.type){case"separator":return r=r.slice(0,r.length-1),we(r);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return r=r.slice(0,r.length-1),we(r);case"string":let n=r[r.length-2];if((n==null?void 0:n.type)==="delimiter")return r=r.slice(0,r.length-1),we(r);if((n==null?void 0:n.type)==="brace"&&n.value==="{")return r=r.slice(0,r.length-1),we(r);break;case"delimiter":return r=r.slice(0,r.length-1),we(r);break}return r},Qr=r=>{let e=[];return r.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?r.push({type:"brace",value:"}"}):t==="]"&&r.push({type:"paren",value:"]"})}),r},Zr=r=>{let e="";return r.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},nt=r=>JSON.parse(Zr(Qr(we(Yr(r)))));var R,K,Ce,rt,Ne,Ie,st,Oe,j,De,it,ot,_e,at,lt,qt,Un,zt,Kt,Xt,Jt,jn,Hn="__json_buf",ct=class r{constructor(){R.add(this),this.messages=[],this.receivedMessages=[],K.set(this,void 0),this.controller=new AbortController,Ce.set(this,void 0),rt.set(this,()=>{}),Ne.set(this,()=>{}),Ie.set(this,void 0),st.set(this,()=>{}),Oe.set(this,()=>{}),j.set(this,{}),De.set(this,!1),it.set(this,!1),ot.set(this,!1),_e.set(this,!1),at.set(this,void 0),lt.set(this,void 0),zt.set(this,e=>{if(h(this,it,!0,"f"),B(e)&&(e=new x),e instanceof x)return h(this,ot,!0,"f"),this._emit("abort",e);if(e instanceof d)return this._emit("error",e);if(e instanceof Error){let t=new d(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new d(String(e)))}),h(this,Ce,new Promise((e,t)=>{h(this,rt,e,"f"),h(this,Ne,t,"f")}),"f"),h(this,Ie,new Promise((e,t)=>{h(this,st,e,"f"),h(this,Oe,t,"f")}),"f"),l(this,Ce,"f").catch(()=>{}),l(this,Ie,"f").catch(()=>{})}get response(){return l(this,at,"f")}get request_id(){return l(this,lt,"f")}async withResponse(){let e=await l(this,Ce,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){let s=new r;for(let i of t.messages)s._addMessageParam(i);return s._run(()=>s._createMessage(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,zt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){var a;let s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,R,"m",Kt).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...n,signal:this.controller.signal}).withResponse();this._connected(i);for await(let c of o)l(this,R,"m",Xt).call(this,c);if((a=o.controller.signal)!=null&&a.aborted)throw new x;l(this,R,"m",Jt).call(this)}_connected(e){this.ended||(h(this,at,e,"f"),h(this,lt,e==null?void 0:e.headers.get("request-id"),"f"),l(this,rt,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,De,"f")}get errored(){return l(this,it,"f")}get aborted(){return l(this,ot,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,j,"f")[e]||(l(this,j,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=l(this,j,"f")[e];if(!n)return this;let s=n.findIndex(i=>i.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(l(this,j,"f")[e]||(l(this,j,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{h(this,_e,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){h(this,_e,!0,"f"),await l(this,Ie,"f")}get currentMessage(){return l(this,K,"f")}async finalMessage(){return await this.done(),l(this,R,"m",qt).call(this)}async finalText(){return await this.done(),l(this,R,"m",Un).call(this)}_emit(e,...t){if(l(this,De,"f"))return;e==="end"&&(h(this,De,!0,"f"),l(this,st,"f").call(this));let n=l(this,j,"f")[e];if(n&&(l(this,j,"f")[e]=n.filter(s=>!s.once),n.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!l(this,_e,"f")&&!(n!=null&&n.length)&&Promise.reject(s),l(this,Ne,"f").call(this,s),l(this,Oe,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!l(this,_e,"f")&&!(n!=null&&n.length)&&Promise.reject(s),l(this,Ne,"f").call(this,s),l(this,Oe,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,R,"m",qt).call(this))}async _fromReadableStream(e,t){var i;let n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),l(this,R,"m",Kt).call(this),this._connected(null);let s=O.fromReadableStream(e,this.controller);for await(let o of s)l(this,R,"m",Xt).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new x;l(this,R,"m",Jt).call(this)}[(K=new WeakMap,Ce=new WeakMap,rt=new WeakMap,Ne=new WeakMap,Ie=new WeakMap,st=new WeakMap,Oe=new WeakMap,j=new WeakMap,De=new WeakMap,it=new WeakMap,ot=new WeakMap,_e=new WeakMap,at=new WeakMap,lt=new WeakMap,zt=new WeakMap,R=new WeakSet,qt=function(){if(this.receivedMessages.length===0)throw new d("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Un=function(){if(this.receivedMessages.length===0)throw new d("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(n=>n.type==="text").map(n=>n.text);if(t.length===0)throw new d("stream ended without producing a content block with type=text");return t.join(" ")},Kt=function(){this.ended||h(this,K,void 0,"f")},Xt=function(t){var s;if(this.ended)return;let n=l(this,R,"m",jn).call(this,t);switch(this._emit("streamEvent",t,n),t.type){case"content_block_delta":{let i=n.content.at(-1);switch(t.delta.type){case"text_delta":{i.type==="text"&&this._emit("text",t.delta.text,i.text||"");break}case"citations_delta":{i.type==="text"&&this._emit("citation",t.delta.citation,(s=i.citations)!=null?s:[]);break}case"input_json_delta":{(i.type==="tool_use"||i.type==="mcp_tool_use")&&i.input&&this._emit("inputJson",t.delta.partial_json,i.input);break}case"thinking_delta":{i.type==="thinking"&&this._emit("thinking",t.delta.thinking,i.thinking);break}case"signature_delta":{i.type==="thinking"&&this._emit("signature",i.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(n),this._addMessage(n,!0);break}case"content_block_stop":{this._emit("contentBlock",n.content.at(-1));break}case"message_start":{h(this,K,n,"f");break}case"content_block_start":case"message_delta":break}},Jt=function(){if(this.ended)throw new d("stream has ended, this shouldn't happen");let t=l(this,K,"f");if(!t)throw new d("request ended without sending any chunks");return h(this,K,void 0,"f"),t},jn=function(t){var s;let n=l(this,K,"f");if(t.type==="message_start"){if(n)throw new d(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!n)throw new d(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return n;case"message_delta":return n.container=t.delta.container,n.stop_reason=t.delta.stop_reason,n.stop_sequence=t.delta.stop_sequence,n.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(n.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(n.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(n.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(n.usage.server_tool_use=t.usage.server_tool_use),n;case"content_block_start":return n.content.push(t.content_block),n;case"content_block_delta":{let i=n.content.at(t.index);switch(t.delta.type){case"text_delta":{(i==null?void 0:i.type)==="text"&&(i.text+=t.delta.text);break}case"citations_delta":{(i==null?void 0:i.type)==="text"&&((s=i.citations)!=null||(i.citations=[]),i.citations.push(t.delta.citation));break}case"input_json_delta":{if((i==null?void 0:i.type)==="tool_use"||(i==null?void 0:i.type)==="mcp_tool_use"){let o=i[Hn]||"";o+=t.delta.partial_json,Object.defineProperty(i,Hn,{value:o,enumerable:!1,writable:!0}),o&&(i.input=nt(o))}break}case"thinking_delta":{(i==null?void 0:i.type)==="thinking"&&(i.thinking+=t.delta.thinking);break}case"signature_delta":{(i==null?void 0:i.type)==="thinking"&&(i.signature=t.delta.signature);break}default:t.delta}return n}case"content_block_stop":return n}},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("streamEvent",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new O(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var ut={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192};var Vn={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"},te=class extends _{constructor(){super(...arguments),this.batches=new be(this._client)}create(e,t){var o,a;let{betas:n,...s}=e;s.model in Vn&&console.warn(`The model '${s.model}' is deprecated and will reach end-of-life on ${Vn[s.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let i=this._client._options.timeout;if(!s.stream&&i==null){let c=(o=ut[s.model])!=null?o:void 0;i=this._client.calculateNonstreamingTimeout(s.max_tokens,c)}return this._client.post("/v1/messages?beta=true",{body:s,timeout:i!=null?i:6e5,...t,headers:g([{...(n==null?void 0:n.toString())!=null?{"anthropic-beta":n==null?void 0:n.toString()}:void 0},t==null?void 0:t.headers]),stream:(a=e.stream)!=null?a:!1})}stream(e,t){return ct.createMessage(this,e,t)}countTokens(e,t){let{betas:n,...s}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:s,...t,headers:g([{"anthropic-beta":[...n!=null?n:[],"token-counting-2024-11-01"].toString()},t==null?void 0:t.headers])})}};te.Batches=be;var D=class extends _{constructor(){super(...arguments),this.models=new ge(this._client),this.messages=new te(this._client),this.files=new me(this._client)}};D.Models=ge;D.Messages=te;D.Files=me;var ne=class extends _{create(e,t){var i,o;let{betas:n,...s}=e;return this._client.post("/v1/complete",{body:s,timeout:(i=this._client._options.timeout)!=null?i:6e5,...t,headers:g([{...(n==null?void 0:n.toString())!=null?{"anthropic-beta":n==null?void 0:n.toString()}:void 0},t==null?void 0:t.headers]),stream:(o=e.stream)!=null?o:!1})}};var C,X,Le,dt,Fe,We,ht,Be,H,$e,ft,pt,Se,mt,gt,Gt,qn,Yt,Qt,Zt,en,zn,Kn="__json_buf",yt=class r{constructor(){C.add(this),this.messages=[],this.receivedMessages=[],X.set(this,void 0),this.controller=new AbortController,Le.set(this,void 0),dt.set(this,()=>{}),Fe.set(this,()=>{}),We.set(this,void 0),ht.set(this,()=>{}),Be.set(this,()=>{}),H.set(this,{}),$e.set(this,!1),ft.set(this,!1),pt.set(this,!1),Se.set(this,!1),mt.set(this,void 0),gt.set(this,void 0),Yt.set(this,e=>{if(h(this,ft,!0,"f"),B(e)&&(e=new x),e instanceof x)return h(this,pt,!0,"f"),this._emit("abort",e);if(e instanceof d)return this._emit("error",e);if(e instanceof Error){let t=new d(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new d(String(e)))}),h(this,Le,new Promise((e,t)=>{h(this,dt,e,"f"),h(this,Fe,t,"f")}),"f"),h(this,We,new Promise((e,t)=>{h(this,ht,e,"f"),h(this,Be,t,"f")}),"f"),l(this,Le,"f").catch(()=>{}),l(this,We,"f").catch(()=>{})}get response(){return l(this,mt,"f")}get request_id(){return l(this,gt,"f")}async withResponse(){let e=await l(this,Le,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){let s=new r;for(let i of t.messages)s._addMessageParam(i);return s._run(()=>s._createMessage(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,Yt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){var a;let s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,C,"m",Qt).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...n,signal:this.controller.signal}).withResponse();this._connected(i);for await(let c of o)l(this,C,"m",Zt).call(this,c);if((a=o.controller.signal)!=null&&a.aborted)throw new x;l(this,C,"m",en).call(this)}_connected(e){this.ended||(h(this,mt,e,"f"),h(this,gt,e==null?void 0:e.headers.get("request-id"),"f"),l(this,dt,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,$e,"f")}get errored(){return l(this,ft,"f")}get aborted(){return l(this,pt,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,H,"f")[e]||(l(this,H,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=l(this,H,"f")[e];if(!n)return this;let s=n.findIndex(i=>i.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(l(this,H,"f")[e]||(l(this,H,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{h(this,Se,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){h(this,Se,!0,"f"),await l(this,We,"f")}get currentMessage(){return l(this,X,"f")}async finalMessage(){return await this.done(),l(this,C,"m",Gt).call(this)}async finalText(){return await this.done(),l(this,C,"m",qn).call(this)}_emit(e,...t){if(l(this,$e,"f"))return;e==="end"&&(h(this,$e,!0,"f"),l(this,ht,"f").call(this));let n=l(this,H,"f")[e];if(n&&(l(this,H,"f")[e]=n.filter(s=>!s.once),n.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!l(this,Se,"f")&&!(n!=null&&n.length)&&Promise.reject(s),l(this,Fe,"f").call(this,s),l(this,Be,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!l(this,Se,"f")&&!(n!=null&&n.length)&&Promise.reject(s),l(this,Fe,"f").call(this,s),l(this,Be,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,C,"m",Gt).call(this))}async _fromReadableStream(e,t){var i;let n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),l(this,C,"m",Qt).call(this),this._connected(null);let s=O.fromReadableStream(e,this.controller);for await(let o of s)l(this,C,"m",Zt).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new x;l(this,C,"m",en).call(this)}[(X=new WeakMap,Le=new WeakMap,dt=new WeakMap,Fe=new WeakMap,We=new WeakMap,ht=new WeakMap,Be=new WeakMap,H=new WeakMap,$e=new WeakMap,ft=new WeakMap,pt=new WeakMap,Se=new WeakMap,mt=new WeakMap,gt=new WeakMap,Yt=new WeakMap,C=new WeakSet,Gt=function(){if(this.receivedMessages.length===0)throw new d("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},qn=function(){if(this.receivedMessages.length===0)throw new d("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(n=>n.type==="text").map(n=>n.text);if(t.length===0)throw new d("stream ended without producing a content block with type=text");return t.join(" ")},Qt=function(){this.ended||h(this,X,void 0,"f")},Zt=function(t){var s;if(this.ended)return;let n=l(this,C,"m",zn).call(this,t);switch(this._emit("streamEvent",t,n),t.type){case"content_block_delta":{let i=n.content.at(-1);switch(t.delta.type){case"text_delta":{i.type==="text"&&this._emit("text",t.delta.text,i.text||"");break}case"citations_delta":{i.type==="text"&&this._emit("citation",t.delta.citation,(s=i.citations)!=null?s:[]);break}case"input_json_delta":{i.type==="tool_use"&&i.input&&this._emit("inputJson",t.delta.partial_json,i.input);break}case"thinking_delta":{i.type==="thinking"&&this._emit("thinking",t.delta.thinking,i.thinking);break}case"signature_delta":{i.type==="thinking"&&this._emit("signature",i.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(n),this._addMessage(n,!0);break}case"content_block_stop":{this._emit("contentBlock",n.content.at(-1));break}case"message_start":{h(this,X,n,"f");break}case"content_block_start":case"message_delta":break}},en=function(){if(this.ended)throw new d("stream has ended, this shouldn't happen");let t=l(this,X,"f");if(!t)throw new d("request ended without sending any chunks");return h(this,X,void 0,"f"),t},zn=function(t){var s;let n=l(this,X,"f");if(t.type==="message_start"){if(n)throw new d(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!n)throw new d(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return n;case"message_delta":return n.stop_reason=t.delta.stop_reason,n.stop_sequence=t.delta.stop_sequence,n.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(n.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(n.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(n.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(n.usage.server_tool_use=t.usage.server_tool_use),n;case"content_block_start":return n.content.push(t.content_block),n;case"content_block_delta":{let i=n.content.at(t.index);switch(t.delta.type){case"text_delta":{(i==null?void 0:i.type)==="text"&&(i.text+=t.delta.text);break}case"citations_delta":{(i==null?void 0:i.type)==="text"&&((s=i.citations)!=null||(i.citations=[]),i.citations.push(t.delta.citation));break}case"input_json_delta":{if((i==null?void 0:i.type)==="tool_use"){let o=i[Kn]||"";o+=t.delta.partial_json,Object.defineProperty(i,Kn,{value:o,enumerable:!1,writable:!0}),o&&(i.input=nt(o))}break}case"thinking_delta":{(i==null?void 0:i.type)==="thinking"&&(i.thinking+=t.delta.thinking);break}case"signature_delta":{(i==null?void 0:i.type)==="thinking"&&(i.signature=t.delta.signature);break}default:t.delta}return n}case"content_block_stop":return n}},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("streamEvent",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new O(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var xe=class extends _{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(M`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",A,{query:e,...t})}delete(e,t){return this._client.delete(M`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(M`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let n=await this.retrieve(e);if(!n.results_url)throw new d(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);return this._client.get(n.results_url,{...t,headers:g([{Accept:"application/binary"},t==null?void 0:t.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((s,i)=>ye.fromResponse(i.response,i.controller))}};var J=class extends _{constructor(){super(...arguments),this.batches=new xe(this._client)}create(e,t){var s,i;e.model in Xn&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Xn[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let n=this._client._options.timeout;if(!e.stream&&n==null){let o=(s=ut[e.model])!=null?s:void 0;n=this._client.calculateNonstreamingTimeout(e.max_tokens,o)}return this._client.post("/v1/messages",{body:e,timeout:n!=null?n:6e5,...t,stream:(i=e.stream)!=null?i:!1})}stream(e,t){return yt.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},Xn={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};J.Batches=xe;var re=class extends _{retrieve(e,t={},n){let{betas:s}=t!=null?t:{};return this._client.get(M`/v1/models/${e}`,{...n,headers:g([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},n==null?void 0:n.headers])})}list(e={},t){let{betas:n,...s}=e!=null?e:{};return this._client.getAPIList("/v1/models",A,{query:s,...t,headers:g([{...(n==null?void 0:n.toString())!=null?{"anthropic-beta":n==null?void 0:n.toString()}:void 0},t==null?void 0:t.headers])})}};var Ue=r=>{var e,t,n,s,i,o;if(typeof globalThis.process!="undefined")return(n=(t=(e=globalThis.process.env)==null?void 0:e[r])==null?void 0:t.trim())!=null?n:void 0;if(typeof globalThis.Deno!="undefined")return(o=(i=(s=globalThis.Deno.env)==null?void 0:s.get)==null?void 0:i.call(s,r))==null?void 0:o.trim()};var Jn,bt,y=class{constructor({baseURL:e=Ue("ANTHROPIC_BASE_URL"),apiKey:t=(i=>(i=Ue("ANTHROPIC_API_KEY"))!=null?i:null)(),authToken:n=(o=>(o=Ue("ANTHROPIC_AUTH_TOKEN"))!=null?o:null)(),...s}={}){var u,p,m,b,f,w;bt.set(this,void 0);let a={apiKey:t,authToken:n,...s,baseURL:e||"https://api.anthropic.com"};if(!a.dangerouslyAllowBrowser&&vn())throw new d(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);this.baseURL=a.baseURL,this.timeout=(u=a.timeout)!=null?u:v.DEFAULT_TIMEOUT,this.logger=(p=a.logger)!=null?p:console;let c="warn";this.logLevel=c,this.logLevel=(b=(m=Dt(a.logLevel,"ClientOptions.logLevel",this))!=null?m:Dt(Ue("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this))!=null?b:c,this.fetchOptions=a.fetchOptions,this.maxRetries=(f=a.maxRetries)!=null?f:2,this.fetch=(w=a.fetch)!=null?w:Rn(),h(this,bt,Nn,"f"),this._options=a,this.apiKey=t,this.authToken=n}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(this.apiKey&&e.get("x-api-key"))&&!t.has("x-api-key")&&!(this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){return g([this.apiKeyAuth(e),this.bearerAuth(e)])}apiKeyAuth(e){if(this.apiKey!=null)return g([{"X-Api-Key":this.apiKey}])}bearerAuth(e){if(this.authToken!=null)return g([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n!="undefined").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new d(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${z}`}defaultIdempotencyKey(){return`stainless-node-retry-${It()}`}makeStatusError(e,t,n,s){return S.generate(e,t,n,s)}buildURL(e,t){let n=_n(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return Sn(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new d("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new Z(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,n){var He,mn,gn;let s=await e,i=(He=s.maxRetries)!=null?He:this.maxRetries;t==null&&(t=i),await this.prepareOptions(s);let{req:o,url:a,timeout:c}=this.buildRequest(s,{retryCount:i-t});await this.prepareRequest(o,{url:a,options:s});let u="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),p=n===void 0?"":`, retryOf: ${n}`,m=Date.now();if(E(this).debug(`[${u}] sending request`,$({retryOfRequestLogID:n,method:s.method,url:a,options:s,headers:o.headers})),(mn=s.signal)!=null&&mn.aborted)throw new x;let b=new AbortController,f=await this.fetchWithTimeout(a,o,c,b).catch(Me),w=Date.now();if(f instanceof Error){let W=`retrying, ${t} attempts remaining`;if((gn=s.signal)!=null&&gn.aborted)throw new x;let I=B(f)||/timed? ?out/i.test(String(f)+("cause"in f?String(f.cause):""));if(t)return E(this).info(`[${u}] connection ${I?"timed out":"failed"} - ${W}`),E(this).debug(`[${u}] connection ${I?"timed out":"failed"} (${W})`,$({retryOfRequestLogID:n,url:a,durationMs:w-m,message:f.message})),this.retryRequest(s,t,n!=null?n:u);throw E(this).info(`[${u}] connection ${I?"timed out":"failed"} - error; no more retries left`),E(this).debug(`[${u}] connection ${I?"timed out":"failed"} (error; no more retries left)`,$({retryOfRequestLogID:n,url:a,durationMs:w-m,message:f.message})),I?new oe:new q({cause:f})}let Q=[...f.headers.entries()].filter(([W])=>W==="request-id").map(([W,I])=>", "+W+": "+JSON.stringify(I)).join(""),ie=`[${u}${p}${Q}] ${o.method} ${a} ${f.ok?"succeeded":"failed"} with status ${f.status} in ${w-m}ms`;if(!f.ok){let W=this.shouldRetry(f);if(t&&W){let Ve=`retrying, ${t} attempts remaining`;return await Cn(f.body),E(this).info(`${ie} - ${Ve}`),E(this).debug(`[${u}] response error (${Ve})`,$({retryOfRequestLogID:n,url:f.url,status:f.status,headers:f.headers,durationMs:w-m})),this.retryRequest(s,t,n!=null?n:u,f.headers)}let I=W?"error; no more retries left":"error; not retryable";E(this).info(`${ie} - ${I}`);let yn=await f.text().catch(Ve=>Me(Ve).message),bn=ze(yn),wn=bn?void 0:yn;throw E(this).debug(`[${u}] response error (${I})`,$({retryOfRequestLogID:n,url:f.url,status:f.status,headers:f.headers,message:wn,durationMs:Date.now()-m})),this.makeStatusError(f.status,bn,wn,f.headers)}return E(this).info(ie),E(this).debug(`[${u}] response start`,$({retryOfRequestLogID:n,url:f.url,status:f.status,headers:f.headers,durationMs:w-m})),{response:f,options:s,controller:b,requestLogID:u,retryOfRequestLogID:n,startTime:m}}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}requestAPIList(e,t){let n=this.makeRequest(t,null,void 0);return new Ae(this,n,e)}async fetchWithTimeout(e,t,n,s){let{signal:i,method:o,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());let c=setTimeout(()=>s.abort(),n),u=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||typeof a.body=="object"&&a.body!==null&&Symbol.asyncIterator in a.body,p={signal:s.signal,...u?{duplex:"half"}:{},method:"GET",...a};o&&(p.method=o.toUpperCase());try{return await this.fetch.call(void 0,e,p)}finally{clearTimeout(c)}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n,s){var c;let i,o=s==null?void 0:s.get("retry-after-ms");if(o){let u=parseFloat(o);Number.isNaN(u)||(i=u)}let a=s==null?void 0:s.get("retry-after");if(a&&!i){let u=parseFloat(a);Number.isNaN(u)?i=Date.parse(a)-Date.now():i=u*1e3}if(!(i&&0<=i&&i<60*1e3)){let u=(c=e.maxRetries)!=null?c:this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,u)}return await Mn(i),this.makeRequest(e,t-1,n)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,o=Math.min(.5*Math.pow(2,i),8),a=1-Math.random()*.25;return o*a*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||t!=null&&e>t)throw new d("Streaming is strongly recommended for operations that may token longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}buildRequest(e,{retryCount:t=0}={}){var b,f,w;let n={...e},{method:s,path:i,query:o}=n,a=this.buildURL(i,o);"timeout"in n&&En("timeout",n.timeout),n.timeout=(b=n.timeout)!=null?b:this.timeout;let{bodyHeaders:c,body:u}=this.buildBody({options:n}),p=this.buildHeaders({options:e,method:s,bodyHeaders:c,retryCount:t});return{req:{method:s,headers:p,...n.signal&&{signal:n.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...(f=this.fetchOptions)!=null?f:{},...(w=n.fetchOptions)!=null?w:{}},url:a,timeout:n.timeout}}buildHeaders({options:e,method:t,bodyHeaders:n,retryCount:s}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let o=g([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...An(),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(o),o.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let n=g([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&n.values.has("content-type")||e instanceof Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Ge(e)}:l(this,bt,"f").call(this,{body:e,headers:n})}};Jn=y,bt=new WeakMap;y.Anthropic=Jn;y.HUMAN_PROMPT=`

Human:`;y.AI_PROMPT=`

Assistant:`;y.DEFAULT_TIMEOUT=6e5;y.AnthropicError=d;y.APIError=S;y.APIConnectionError=q;y.APIConnectionTimeoutError=oe;y.APIUserAbortError=x;y.NotFoundError=ue;y.ConflictError=de;y.RateLimitError=fe;y.BadRequestError=ae;y.AuthenticationError=le;y.InternalServerError=pe;y.PermissionDeniedError=ce;y.UnprocessableEntityError=he;y.toFile=tt;var v=class extends y{constructor(){super(...arguments),this.completions=new ne(this),this.messages=new J(this),this.models=new re(this),this.beta=new D(this)}};v.Completions=ne;v.Messages=J;v.Models=re;v.Beta=D;var{HUMAN_PROMPT:rs,AI_PROMPT:ss}=v;var tn=`You are a gentle, curious companion helping someone journal and reflect. Your role is to help them explore their feelings and thoughts more deeply.

Guidelines:
- Ask open-ended questions that invite introspection
- Reflect back what you notice without judgment
- Be warm and supportive
- Keep responses brief (1-2 sentences usually)
- Don't give advice unless explicitly asked
- Focus on feelings, not fixing

Example responses:
- "What does 'stuck' feel like in your body right now?"
- "You mentioned this happened before. What was different this time?"
- "There's something tender here. Want to stay with it?"`,nn=`You are observing someone's journaling and reflection. Offer brief, gentle observations as margin notes.

Guidelines:
- Notice patterns or themes without interrupting
- Point out emotions that might be worth exploring
- Keep observations to one short sentence
- Don't ask questions (that's for Muse mode)
- Only comment when there's something genuinely worth noting
- Be subtle and non-intrusive

Example observations:
- "This seems connected to what you wrote earlier about trust."
- "A shift in tone here."
- "You've circled back to this theme."`;var rn=`You are an intellectual sparring partner helping someone develop ideas. Your role is to strengthen their thinking by offering perspectives, challenges, and connections.

Guidelines:
- Suggest angles they haven't considered
- Point out assumptions worth questioning
- Offer counterarguments to strengthen their position
- Make connections to other ideas or fields
- Keep responses crisp and provocative
- Be intellectually honest, not just agreeable

Example responses:
- "This assumes X. What if that's not true?"
- "Steel-man the opposing view here\u2014what's the strongest case against this?"
- "This connects to [concept]. Have you considered that angle?"`,sn=`You are observing someone developing ideas and arguments. Offer brief, sharp observations as margin notes.

Guidelines:
- Spot logical gaps or unsupported claims
- Notice when an argument could be stronger
- Point out interesting connections
- Keep observations to one short sentence
- Don't ask questions (that's for Muse mode)
- Only comment when there's something genuinely useful to say
- Be intellectually rigorous but not dismissive

Example observations:
- "Bold claim. Evidence?"
- "You made this point in paragraph 2."
- "This contradicts your earlier assertion."
- "Counterexample: [brief mention]"`;var on=`You are an execution-focused thinking partner helping someone plan and organize. Your role is to clarify, prioritize, and spot gaps.

Guidelines:
- Help break down vague intentions into concrete next actions
- Identify missing steps or dependencies
- Suggest prioritization when there are many items
- Flag potential blockers or risks
- Keep responses action-oriented
- Don't add unnecessary complexity

Example responses:
- "What's the very next physical action here?"
- "This depends on Y\u2014should that be a separate task?"
- "Three things here. Which one unblocks the others?"`,an=`You are observing someone planning and organizing. Offer brief, practical observations as margin notes.

Guidelines:
- Spot missing dependencies or steps
- Notice when priorities aren't clear
- Point out potential blockers
- Keep observations to one short sentence
- Don't ask questions (that's for Muse mode)
- Only comment when there's something genuinely useful to say
- Be practical and action-oriented

Example observations:
- "This depends on the previous item."
- "Missing: who's responsible?"
- "This section is getting long."
- "Deadline not specified."`;function ln(r,e){if(e==="whisper")switch(r){case"reflect":return nn;case"think":return sn;case"plan":return an}switch(r){case"reflect":return tn;case"think":return rn;case"plan":return on}}var cn=/::muse\[(.*?)\]::/g,un=/::whisper\[(.*?)\]::/g,dn=/:::muse\n([\s\S]*?)\n:::/g,hn=/:::whisper\n([\s\S]*?)\n:::/g;function is(r){let e=[],t;for(cn.lastIndex=0;(t=cn.exec(r))!==null;)e.push({type:"muse",content:t[1],isMultiline:!1,start:t.index,end:t.index+t[0].length});for(un.lastIndex=0;(t=un.exec(r))!==null;)e.push({type:"whisper",content:t[1],isMultiline:!1,start:t.index,end:t.index+t[0].length});for(dn.lastIndex=0;(t=dn.exec(r))!==null;)e.push({type:"muse",content:t[1],isMultiline:!0,start:t.index,end:t.index+t[0].length});for(hn.lastIndex=0;(t=hn.exec(r))!==null;)e.push({type:"whisper",content:t[1],isMultiline:!0,start:t.index,end:t.index+t[0].length});return e.sort((n,s)=>n.start-s.start),e}function fn(r){let e=r;return e=e.replace(dn,""),e=e.replace(hn,""),e=e.replace(cn,""),e=e.replace(un,""),e=e.replace(/\n{3,}/g,`

`),e}function Gn(r,e){return is(r).some(n=>e>=n.start&&e<=n.end)}function Yn(r){return fn(r).trim()}var wt=class{constructor(e,t="claude-sonnet-4-20250514"){this.client=null;this.stats={tokensThisSession:0,tokensToday:0,lastResponseTime:0,currentContextSize:0};this.model=t,e&&(this.client=new v({apiKey:e,dangerouslyAllowBrowser:!0}))}setApiKey(e){e?this.client=new v({apiKey:e,dangerouslyAllowBrowser:!0}):this.client=null}setModel(e){this.model=e}isConfigured(){return this.client!==null}getStats(){return{...this.stats}}resetSessionStats(){this.stats.tokensThisSession=0}buildUserMessage(e){let t=Yn(e.noteContent),n="";return e.linkedNotes&&e.linkedNotes.length>0&&(n+=`## Linked Notes Context

`,n+=e.linkedNotes.join(`

`),n+=`

---

`),n+=`## Current Note

`,e.style==="muse"&&e.cursorPosition!==void 0?(n+=t.substring(0,e.cursorPosition),n+=`

[CURSOR POSITION - respond to what comes before this point]`):n+=t,n}async generateMuseResponse(e,t,n){if(!this.client)throw new Error("Claude API not configured. Please add your API key in settings.");let s=Date.now(),i=ln(e.mood,"muse"),o=this.buildUserMessage(e);this.stats.currentContextSize=o.length;try{let a=this.client.messages.stream({model:this.model,max_tokens:300,system:i,messages:[{role:"user",content:o}]}),c="";a.on("text",p=>{c+=p,t(p)});let u=await a.finalMessage();this.stats.lastResponseTime=Date.now()-s,u.usage&&(this.stats.tokensThisSession+=u.usage.input_tokens+u.usage.output_tokens,this.stats.tokensToday+=u.usage.input_tokens+u.usage.output_tokens),n(c)}catch(a){throw console.error("Claude API error:",a),a}}async generateWhisperResponse(e){if(!this.client)throw new Error("Claude API not configured. Please add your API key in settings.");let t=Date.now(),n=ln(e.mood,"whisper"),s=this.buildUserMessage(e);this.stats.currentContextSize=s.length;try{let i=await this.client.messages.create({model:this.model,max_tokens:100,system:n+`

IMPORTANT: Only respond if you have something genuinely useful to observe. If not, respond with exactly "NO_WHISPER" and nothing else.`,messages:[{role:"user",content:s}]});this.stats.lastResponseTime=Date.now()-t,i.usage&&(this.stats.tokensThisSession+=i.usage.input_tokens+i.usage.output_tokens,this.stats.tokensToday+=i.usage.input_tokens+i.usage.output_tokens);let o=i.content.find(c=>c.type==="text");if(!o||o.type!=="text")return null;let a=o.text.trim();return a==="NO_WHISPER"||a.includes("NO_WHISPER")?null:a}catch(i){throw console.error("Claude API error:",i),i}}async testConnection(){if(!this.client)return!1;try{return await this.client.messages.create({model:this.model,max_tokens:10,messages:[{role:"user",content:"Hi"}]}),!0}catch(e){return console.error("API connection test failed:",e),!1}}};var G=require("obsidian");var xt=class xt{constructor(e=2){this.pauseTimer=null;this.lastEnterTime=0;this.lastContent="";this.onPauseTrigger=null;this.onDoubleEnterTrigger=null;this.enabled=!1;this.pauseDuration=e*1e3}enable(){this.enabled=!0}disable(){this.enabled=!1,this.clearPauseTimer()}isEnabled(){return this.enabled}setPauseDuration(e){this.pauseDuration=e*1e3}onPause(e){this.onPauseTrigger=e}onDoubleEnter(e){this.onDoubleEnterTrigger=e}handleUpdate(e){if(!this.enabled||!e.docChanged)return!1;let t=e.state.doc.toString();return t!==this.lastContent?this.checkDoubleEnter(e)?!0:(this.resetPauseTimer(),this.lastContent=t,!1):!1}checkDoubleEnter(e){let t=!1;if(e.changes.iterChanges((i,o,a,c,u)=>{let p=u.toString();(p===`
`||p===`\r
`)&&(t=!0)}),!t)return!1;let n=Date.now();return n-this.lastEnterTime<xt.DOUBLE_ENTER_THRESHOLD?(this.lastEnterTime=0,this.clearPauseTimer(),this.onDoubleEnterTrigger&&this.onDoubleEnterTrigger(),!0):(this.lastEnterTime=n,!1)}clearPauseTimer(){this.pauseTimer&&(clearTimeout(this.pauseTimer),this.pauseTimer=null)}resetPauseTimer(){this.clearPauseTimer(),this.pauseTimer=setTimeout(()=>{this.enabled&&this.onPauseTrigger&&this.onPauseTrigger()},this.pauseDuration)}setContent(e){this.lastContent=e}hasNewContent(e){return e!==this.lastContent}markProcessed(e){this.lastContent=e}destroy(){this.clearPauseTimer(),this.onPauseTrigger=null,this.onDoubleEnterTrigger=null,this.enabled=!1}};xt.DOUBLE_ENTER_THRESHOLD=300;var _t=xt,Ee=class Ee{constructor(){this.analysisTimer=null;this.lastAnalyzedContent="";this.lastWhisperTime=0;this.onAnalyzeTrigger=null;this.enabled=!1}enable(){this.enabled=!0,this.startAnalysisLoop()}disable(){this.enabled=!1,this.stopAnalysisLoop()}isEnabled(){return this.enabled}onAnalyze(e){this.onAnalyzeTrigger=e}startAnalysisLoop(){this.stopAnalysisLoop(),this.analysisTimer=setInterval(()=>{this.enabled&&this.canWhisper()&&this.onAnalyzeTrigger&&this.onAnalyzeTrigger()},Ee.ANALYSIS_INTERVAL)}stopAnalysisLoop(){this.analysisTimer&&(clearInterval(this.analysisTimer),this.analysisTimer=null)}canWhisper(){return Date.now()-this.lastWhisperTime>=Ee.MIN_WHISPER_INTERVAL}hasSignificantChange(e){return e===this.lastAnalyzedContent?!1:Math.abs(e.length-this.lastAnalyzedContent.length)>=50}markAnalyzed(e){this.lastAnalyzedContent=e,this.lastWhisperTime=Date.now()}destroy(){this.stopAnalysisLoop(),this.onAnalyzeTrigger=null,this.enabled=!1}};Ee.MIN_WHISPER_INTERVAL=3e4,Ee.ANALYSIS_INTERVAL=5e3;var St=Ee;var tr=require("obsidian");function Qn(r,e){let t=r.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter))return{};let n=t.frontmatter,s={};if(n["enchant-style"]){let i=n["enchant-style"].toLowerCase();(i==="muse"||i==="whisper")&&(s.style=i)}if(n["enchant-mood"]){let i=n["enchant-mood"].toLowerCase();(i==="reflect"||i==="think"||i==="plan")&&(s.mood=i)}return n.type&&(s.type=n.type.toLowerCase()),s}function Zn(r){return{journal:"reflect",diary:"reflect",reflection:"reflect",essay:"think",writing:"think",article:"think",idea:"think",ideas:"think",project:"plan",todo:"plan",task:"plan",tasks:"plan",plan:"plan",planning:"plan"}[r.toLowerCase()]||null}var er={journal:"reflect",journals:"reflect",diary:"reflect",diaries:"reflect",reflection:"reflect",reflections:"reflect",project:"plan",projects:"plan",todo:"plan",todos:"plan",task:"plan",tasks:"plan",planning:"plan",essay:"think",essays:"think",writing:"think",writings:"think",idea:"think",ideas:"think",article:"think",articles:"think"},os=[{pattern:/\bI feel\b/i,mood:"reflect"},{pattern:/\bI felt\b/i,mood:"reflect"},{pattern:/\bToday I\b/i,mood:"reflect"},{pattern:/\bI'm feeling\b/i,mood:"reflect"},{pattern:/\bI've been feeling\b/i,mood:"reflect"},{pattern:/\bI noticed\b/i,mood:"reflect"},{pattern:/\bI'm grateful\b/i,mood:"reflect"},{pattern:/\bI'm struggling\b/i,mood:"reflect"},{pattern:/^- \[ \]/m,mood:"plan"},{pattern:/^- \[x\]/im,mood:"plan"},{pattern:/\bTODO\b/i,mood:"plan"},{pattern:/\bnext steps\b/i,mood:"plan"},{pattern:/\baction items\b/i,mood:"plan"},{pattern:/\bdeadline\b/i,mood:"plan"},{pattern:/\bthe argument is\b/i,mood:"think"},{pattern:/\bmy thesis\b/i,mood:"think"},{pattern:/\bI argue\b/i,mood:"think"},{pattern:/\bI believe\b/i,mood:"think"},{pattern:/\bthe evidence\b/i,mood:"think"},{pattern:/\bthe reason\b/i,mood:"think"},{pattern:/\bin conclusion\b/i,mood:"think"},{pattern:/\bfurthermore\b/i,mood:"think"},{pattern:/\bhowever\b/i,mood:"think"}];function as(r){let e=r.toLowerCase().split("/");for(let t of e)if(er[t])return er[t];return null}function ls(r){let e={reflect:0,think:0,plan:0};for(let{pattern:s,mood:i}of os){let o=r.match(new RegExp(s,"g"));o&&(e[i]+=o.length)}let t=null,n=0;for(let[s,i]of Object.entries(e))i>n&&(n=i,t=s);return n>=2?t:null}function Et(r,e,t,n){let s=Qn(r,e);if(s.mood)return{mood:s.mood,style:s.style||(n.defaultStyle==="off"?"muse":n.defaultStyle),source:"frontmatter"};if(s.type){let a=Zn(s.type);if(a)return{mood:a,style:s.style||(n.defaultStyle==="off"?"muse":n.defaultStyle),source:"frontmatter"}}let i=as(e.path);if(i)return{mood:i,style:s.style||(n.defaultStyle==="off"?"muse":n.defaultStyle),source:"folder"};let o=ls(t);return o?{mood:o,style:s.style||(n.defaultStyle==="off"?"muse":n.defaultStyle),source:"content"}:{mood:n.defaultMood==="auto"?"reflect":n.defaultMood,style:n.defaultStyle==="off"?"muse":n.defaultStyle,source:"default"}}async function je(r,e,t,n=new Set){let s=[];if(t<=0||n.has(e.path))return s;n.add(e.path);let i=r.metadataCache.getFileCache(e);if(!(i!=null&&i.links))return s;for(let o of i.links){let a=r.metadataCache.getFirstLinkpathDest(o.link,e.path);if(a&&a instanceof tr.TFile&&!n.has(a.path))try{let c=await r.vault.read(a);if(s.push(`--- ${a.basename} ---
${c}`),t>1){let u=await je(r,a,t-1,n);s.push(...u)}}catch(c){console.warn(`Couldn't read linked file: ${a.path}`)}}return s}var Mt=class{constructor(e,t,n){this.isGenerating=!1;this.currentMood="auto";this.app=e,this.claudeClient=t,this.settings=n,this.triggerManager=new _t(n.pauseDuration),this.setupTriggers()}setupTriggers(){this.triggerManager.onPause(()=>this.handleTrigger()),this.triggerManager.onDoubleEnter(()=>this.handleTrigger())}enable(){this.triggerManager.enable(),new G.Notice("Muse mode enabled")}disable(){this.triggerManager.disable(),new G.Notice("Muse mode disabled")}toggle(){this.triggerManager.isEnabled()?this.disable():this.enable()}isEnabled(){return this.triggerManager.isEnabled()}setMood(e){this.currentMood=e,new G.Notice(`Mood set to: ${e==="auto"?"Auto-detect":e}`)}getMood(){return this.currentMood}updateSettings(e){this.settings=e,this.triggerManager.setPauseDuration(e.pauseDuration)}handleEditorUpdate(e){}async summon(){await this.handleTrigger()}async handleTrigger(){if(this.isGenerating)return;let e=this.app.workspace.getActiveViewOfType(G.MarkdownView);if(!e)return;let t=e.file;if(!t)return;let n=e.editor,s=n.getValue(),i=n.getCursor(),o=n.posToOffset(i);if(!Gn(s,o)&&this.triggerManager.hasNewContent(s)){if(!this.claudeClient.isConfigured()){new G.Notice("Please configure your Claude API key in settings");return}this.isGenerating=!0;try{let a=Et(this.app,t,s,this.settings),c=this.currentMood!=="auto"?this.currentMood:a.mood,u={noteContent:s,cursorPosition:o,mood:c,style:"muse",notePath:t.path};this.settings.enableLinkedNoteContext&&(u.linkedNotes=await je(this.app,t,this.settings.linkedNoteDepth));let p=o;n.replaceRange(`

::muse[...]::  `,n.offsetToPos(o));let m="",b=p+2;await this.claudeClient.generateMuseResponse(u,f=>{m+=f;let w=n.getValue(),Q=w.match(/::muse\[([^\]]*)\]::/);if(Q){let ie=w.indexOf(Q[0]),He=ie+Q[0].length;n.replaceRange(`::muse[${m}]::`,n.offsetToPos(ie),n.offsetToPos(He))}},f=>{this.triggerManager.markProcessed(n.getValue())})}catch(a){console.error("Muse generation error:",a),new G.Notice(`Muse error: ${a instanceof Error?a.message:"Unknown error"}`);let c=n.getValue(),u=c.match(/::muse\[\.\.\.\]::/);if(u){let p=c.indexOf(u[0]),m=p+u[0].length;n.replaceRange("",n.offsetToPos(p),n.offsetToPos(m))}}finally{this.isGenerating=!1}}}getTriggerManager(){return this.triggerManager}destroy(){this.triggerManager.destroy()}};var se=require("obsidian");var L=require("@codemirror/view"),V=require("@codemirror/state"),nr=/::whisper\[(.*?)\]::/g,ir=V.StateEffect.define(),cs=V.StateEffect.define(),or=V.StateEffect.define(),rr=V.StateField.define({create(){return[]},update(r,e){let t=r;for(let n of e.effects)n.is(ir)?(t=t.filter(s=>s.line!==n.value.line),t=[...t,n.value]):n.is(cs)?t=t.filter(s=>s.line!==n.value):n.is(or)&&(t=[]);return e.docChanged&&(t=t.map(n=>{let s=e.startState.doc.line(Math.min(n.line,e.startState.doc.lines)),i=e.changes.mapPos(s.from);try{let o=e.state.doc.lineAt(i);return{...n,line:o.number}}catch(o){return null}}).filter(n=>n!==null)),t}}),kt=class extends L.GutterMarker{constructor(t){super();this.content=t}toDOM(){let t=document.createElement("div");return t.className="cm-enchanted-whisper-marker",t.title=this.content,t.addEventListener("click",n=>{n.stopPropagation(),this.showTooltip(t)}),t}showTooltip(t){let n=document.querySelector(".enchanted-whisper-tooltip");if(n){n.remove();return}let s=document.createElement("div");s.className="enchanted-whisper-tooltip",s.textContent=this.content;let i=t.getBoundingClientRect();s.style.position="fixed",s.style.top=`${i.top}px`,s.style.left=`${i.right+10}px`,document.body.appendChild(s);let o=()=>{s.remove(),document.removeEventListener("click",o)};setTimeout(()=>{document.addEventListener("click",o)},0)}};function ar(){return[rr,(0,L.gutter)({class:"enchanted-whisper-gutter",markers:r=>{let e=r.state.field(rr),t=new V.RangeSetBuilder;for(let n of e)try{let s=r.state.doc.line(n.line);t.add(s.from,s.from,new kt(n.content))}catch(s){}return t.finish()},initialSpacer:()=>new kt("")})]}var pn=class extends L.WidgetType{constructor(t,n){super();this.content=t;this.onDismiss=n}toDOM(){let t=document.createElement("span");return t.className="enchanted-whisper-inline",t.textContent=this.content,t.onclick=()=>this.onDismiss(),t.title="Click to dismiss",t}ignoreEvent(){return!1}};function sr(r){let e=new V.RangeSetBuilder,t=r.state.doc.toString();nr.lastIndex=0;let n;for(;(n=nr.exec(t))!==null;){let s=n.index,i=s+n[0].length,o=n[1];e.add(s,i,L.Decoration.replace({widget:new pn(o,()=>{r.dispatch({changes:{from:s,to:i,insert:""}})})}))}return e.finish()}function lr(){return L.ViewPlugin.fromClass(class{constructor(r){this.decorations=sr(r)}update(r){(r.docChanged||r.viewportChanged)&&(this.decorations=sr(r.view))}},{decorations:r=>r.decorations})}function cr(r,e,t){r.dispatch({effects:ir.of({line:e,content:t})})}function ur(r){r.dispatch({effects:or.of()})}var Pt=class{constructor(e,t,n){this.isAnalyzing=!1;this.currentMood="auto";this.lastParagraphAnalyzed=-1;this.app=e,this.claudeClient=t,this.settings=n,this.triggerManager=new St,this.setupTriggers()}setupTriggers(){this.triggerManager.onAnalyze(()=>this.handleAnalyze())}enable(){this.triggerManager.enable(),new se.Notice("Whisper mode enabled")}disable(){this.triggerManager.disable(),new se.Notice("Whisper mode disabled")}toggle(){this.triggerManager.isEnabled()?this.disable():this.enable()}isEnabled(){return this.triggerManager.isEnabled()}setMood(e){this.currentMood=e}updateSettings(e){this.settings=e}async handleAnalyze(){if(this.isAnalyzing)return;let e=this.app.workspace.getActiveViewOfType(se.MarkdownView);if(!e)return;let t=e.file;if(!t)return;let s=e.editor.getValue();if(!this.triggerManager.hasSignificantChange(s)||!this.claudeClient.isConfigured())return;let i=this.findParagraphToAnalyze(s);if(i!==null){this.isAnalyzing=!0;try{let o=Et(this.app,t,s,this.settings),a=this.currentMood!=="auto"?this.currentMood:o.mood,c={noteContent:s,mood:a,style:"whisper",notePath:t.path};this.settings.enableLinkedNoteContext&&(c.linkedNotes=await je(this.app,t,this.settings.linkedNoteDepth));let u=await this.claudeClient.generateWhisperResponse(c);if(u){let p=e.editor.cm;if(p){let m=this.getLineForParagraph(s,i);cr(p,m,u)}this.lastParagraphAnalyzed=i}this.triggerManager.markAnalyzed(s)}catch(o){console.error("Whisper analysis error:",o)}finally{this.isAnalyzing=!1}}}findParagraphToAnalyze(e){let t=e.split(/\n\n+/),n=[];for(let i=0;i<t.length;i++){let o=t[i].trim();o.length>50&&!o.startsWith("::muse[")&&!o.startsWith(":::muse")&&!o.startsWith("::whisper[")&&!o.startsWith("---")&&n.push(i)}if(n.length===0)return null;let s=n.filter(i=>i!==this.lastParagraphAnalyzed);return s.length===0?n[n.length-1]:s[s.length-1]}getLineForParagraph(e,t){let n=e.split(/\n\n+/),s=1;for(let i=0;i<t&&i<n.length;i++){let o=n[i].split(`
`).length;s+=o,s+=1}return s}clearWhispers(){let e=this.app.workspace.getActiveViewOfType(se.MarkdownView);if(!e)return;let t=e.editor.cm;t&&ur(t),new se.Notice("Whispers cleared")}destroy(){this.triggerManager.destroy()}};var N=require("obsidian");var F=require("@codemirror/view"),hr=require("@codemirror/state"),Tt=/::muse\[(.*?)\]::/g;var Y=new Set,vt=class extends F.WidgetType{constructor(t,n,s){super();this.content=t;this.isMultiline=n;this.onDismiss=s}toDOM(){let t=document.createElement("span");t.className=this.isMultiline?"enchanted-muse-block":"enchanted-muse";let n=document.createElement("span");n.className="enchanted-muse-content",n.textContent=this.content,t.appendChild(n);let s=document.createElement("button");return s.className=this.isMultiline?"enchanted-muse-block-dismiss":"enchanted-muse-dismiss",s.textContent="\xD7",s.onclick=i=>{i.preventDefault(),i.stopPropagation(),this.onDismiss()},t.appendChild(s),t}ignoreEvent(){return!1}},At=class extends F.WidgetType{constructor(t){super();this.onReveal=t}toDOM(){let t=document.createElement("span");return t.className="enchanted-stowed",t.title="Click to reveal enchantment",t.onclick=n=>{n.preventDefault(),n.stopPropagation(),this.onReveal()},t}ignoreEvent(){return!1}};function dr(r,e=!1){let t=new hr.RangeSetBuilder,n=r.state.doc.toString();Tt.lastIndex=0;let s;for(;(s=Tt.exec(n))!==null;){let p=s.index,m=p+s[0].length,b=s[1];Y.has(p)&&!e?t.add(p,m,F.Decoration.replace({widget:new At(()=>{Y.delete(p),r.dispatch({effects:[]})})})):t.add(p,m,F.Decoration.replace({widget:new vt(b,!1,()=>{r.dispatch({changes:{from:p,to:m,insert:""}})})}))}let i=n.split(`
`),o=0,a=!1,c=0,u="";for(let p=0;p<i.length;p++){let m=i[p],b=o,f=o+m.length;if(!a&&m.match(/^:::muse\s*$/))a=!0,c=b,u="";else if(a&&m.match(/^:::$/)){let w=f;Y.has(c)&&!e?t.add(c,w,F.Decoration.replace({widget:new At(()=>{Y.delete(c),r.dispatch({effects:[]})})})):t.add(c,w,F.Decoration.replace({widget:new vt(u.trim(),!0,()=>{r.dispatch({changes:{from:c,to:w,insert:""}})})})),a=!1,u=""}else a&&(u+=(u?`
`:"")+m);o=f+1}return t.finish()}function fr(){return F.ViewPlugin.fromClass(class{constructor(r){this.decorations=dr(r)}update(r){(r.docChanged||r.viewportChanged)&&(this.decorations=dr(r.view))}},{decorations:r=>r.decorations})}function pr(r){let e=r.state.doc.toString();Tt.lastIndex=0;let t;for(;(t=Tt.exec(e))!==null;)Y.add(t.index);let n=e.split(`
`),s=0;for(let i=0;i<n.length;i++)n[i].match(/^:::muse\s*$/)&&Y.add(s),s+=n[i].length+1;r.dispatch({effects:[]})}function mr(r){Y.clear(),r.dispatch({effects:[]})}function gr(){Y.clear()}function yr(r,e,t,n){e({id:"toggle-muse",name:"Toggle Muse",hotkeys:[{modifiers:["Mod","Shift"],key:"m"}],callback:()=>{t.toggle()}}),e({id:"toggle-whisper",name:"Toggle Whisper",hotkeys:[{modifiers:["Mod","Shift"],key:"w"}],callback:()=>{n.toggle()}}),e({id:"stow-enchantments",name:"Stow Enchantments",checkCallback:s=>{let i=r.workspace.getActiveViewOfType(N.MarkdownView);if(!i)return!1;if(!s){let o=i.editor.cm;o&&(pr(o),new N.Notice("Enchantments stowed"))}return!0}}),e({id:"reveal-enchantments",name:"Reveal Enchantments",checkCallback:s=>{let i=r.workspace.getActiveViewOfType(N.MarkdownView);if(!i)return!1;if(!s){let o=i.editor.cm;o&&(mr(o),new N.Notice("Enchantments revealed"))}return!0}}),e({id:"banish-enchantments",name:"Banish Enchantments",checkCallback:s=>{let i=r.workspace.getActiveViewOfType(N.MarkdownView);if(!i)return!1;if(!s){let o=i.editor,a=o.getValue(),c=fn(a);a!==c?(o.setValue(c),new N.Notice("Enchantments banished")):new N.Notice("No enchantments to banish")}return!0}}),e({id:"set-mood-reflect",name:"Set Mood: Reflect",callback:()=>{t.setMood("reflect"),n.setMood("reflect")}}),e({id:"set-mood-think",name:"Set Mood: Think",callback:()=>{t.setMood("think"),n.setMood("think")}}),e({id:"set-mood-plan",name:"Set Mood: Plan",callback:()=>{t.setMood("plan"),n.setMood("plan")}}),e({id:"set-mood-auto",name:"Set Mood: Auto-detect",callback:()=>{t.setMood("auto"),n.setMood("auto")}}),e({id:"set-mood",name:"Set Mood",callback:()=>{var a;let s=[{mood:"auto",label:"Auto-detect"},{mood:"reflect",label:"Reflect (journaling)"},{mood:"think",label:"Think (essays/ideas)"},{mood:"plan",label:"Plan (todos/planning)"}],i=document.createElement("div");i.className="modal-container mod-dim",i.innerHTML=`
        <div class="modal-bg" style="opacity: 0.85;"></div>
        <div class="modal" style="width: 300px;">
          <div class="modal-title">Set Mood</div>
          <div class="modal-content" style="padding: 1em;">
            ${s.map((c,u)=>`
              <button class="mod-cta" style="width: 100%; margin-bottom: 0.5em;" data-mood="${c.mood}">
                ${c.label}
              </button>
            `).join("")}
          </div>
        </div>
      `,document.body.appendChild(i),i.querySelectorAll("button").forEach(c=>{c.addEventListener("click",()=>{let u=c.dataset.mood;t.setMood(u),n.setMood(u),i.remove()})}),(a=i.querySelector(".modal-bg"))==null||a.addEventListener("click",()=>{i.remove()});let o=c=>{c.key==="Escape"&&(i.remove(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)}}),e({id:"summon-muse",name:"Summon Muse",checkCallback:s=>r.workspace.getActiveViewOfType(N.MarkdownView)?(s||t.summon(),!0):!1}),e({id:"clear-whispers",name:"Clear Whispers",checkCallback:s=>r.workspace.getActiveViewOfType(N.MarkdownView)?(s||n.clearWhispers(),!0):!1})}var Rt=class extends br.Plugin{constructor(){super(...arguments);this.settings=Nt;this.claudeClient=null;this.museMode=null;this.whisperMode=null;this.editorExtensions=[]}async onload(){console.log("Loading Enchanted Notes plugin"),await this.loadSettings(),this.claudeClient=new wt(this.settings.apiKey,this.settings.model),this.museMode=new Mt(this.app,this.claudeClient,this.settings),this.whisperMode=new Pt(this.app,this.claudeClient,this.settings),this.settings.defaultStyle==="muse"?this.museMode.enable():this.settings.defaultStyle==="whisper"&&this.whisperMode.enable(),yr(this.app,t=>this.addCommand(t),this.museMode,this.whisperMode),this.addSettingTab(new qe(this.app,this)),this.registerEditorExtensions(),this.setupStatusBar()}registerEditorExtensions(){let t=fr(),n=ar(),s=lr(),i=wr.ViewPlugin.fromClass(class{constructor(o){this.view=o}update(o){var a;o.docChanged&&((a=this.plugin)!=null&&a.museMode)&&this.plugin.museMode.getTriggerManager().handleUpdate(o)}get plugin(){var o;return((o=this.view.state.facet(pluginFacet))==null?void 0:o[0])||null}});this.registerEditorExtension([t,n,s])}setupStatusBar(){let t=super.addStatusBarItem();t.addClass("enchanted-status");let n=()=>{var u,p;let s=((u=this.museMode)==null?void 0:u.isEnabled())||!1,i=((p=this.whisperMode)==null?void 0:p.isEnabled())||!1,o="",a="";s&&i?(o="Muse + Whisper",a="active"):s?(o="Muse",a="active"):i?(o="Whisper",a="whisper-active"):(o="Enchanted",a=""),t.empty();let c=t.createSpan({cls:`enchanted-status-indicator ${a}`});t.createSpan({text:o})};this.registerInterval(window.setInterval(n,1e3)),n()}async onunload(){var t,n;console.log("Unloading Enchanted Notes plugin"),(t=this.museMode)==null||t.destroy(),(n=this.whisperMode)==null||n.destroy(),gr()}async loadSettings(){this.settings=Object.assign({},Nt,await this.loadData())}async saveSettings(){var t,n;await this.saveData(this.settings),(t=this.museMode)==null||t.updateSettings(this.settings),(n=this.whisperMode)==null||n.updateSettings(this.settings)}updateApiKey(t){var n;(n=this.claudeClient)==null||n.setApiKey(t)}updateModel(t){var n;(n=this.claudeClient)==null||n.setModel(t)}updatePauseDuration(t){var n;(n=this.museMode)==null||n.updateSettings({...this.settings,pauseDuration:t})}getStats(){var t;return((t=this.claudeClient)==null?void 0:t.getStats())||{tokensThisSession:0,tokensToday:0,lastResponseTime:0,currentContextSize:0}}resetSessionStats(){var t;(t=this.claudeClient)==null||t.resetSessionStats()}};

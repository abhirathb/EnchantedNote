/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Bt=Object.defineProperty;var vn=Object.getOwnPropertyDescriptor;var Pn=Object.getOwnPropertyNames;var kn=Object.prototype.hasOwnProperty;var Tn=(r,e)=>{for(var t in e)Bt(r,t,{get:e[t],enumerable:!0})},An=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Pn(e))!kn.call(r,n)&&n!==t&&Bt(r,n,{get:()=>e[n],enumerable:!(s=vn(e,n))||s.enumerable});return r};var Rn=r=>An(Bt({},"__esModule",{value:!0}),r);var pr={};Tn(pr,{default:()=>Dt});module.exports=Rn(pr);var xn=require("obsidian"),En=require("@codemirror/view");var $t={provider:"claude",claudeApiKey:"",claudeModel:"claude-sonnet-4-20250514",ollamaBaseUrl:"http://localhost:11434",ollamaModel:"",defaultStyle:"muse",defaultMood:"auto",pauseDuration:2,enableLinkedNoteContext:!1,linkedNoteDepth:1,showDeveloperPanel:!1};var b=require("obsidian");function f(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t}function l(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)}var Ft=function(){let{crypto:r}=globalThis;if(r!=null&&r.randomUUID)return Ft=r.randomUUID.bind(r),r.randomUUID();let e=new Uint8Array(1),t=r?()=>r.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,s=>(+s^t()&15>>+s/4).toString(16))};function U(r){return typeof r=="object"&&r!==null&&("name"in r&&r.name==="AbortError"||"message"in r&&String(r.message).includes("FetchRequestCanceledException"))}var Ae=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null){try{if(Object.prototype.toString.call(r)==="[object Error]"){let e=new Error(r.message,r.cause?{cause:r.cause}:{});return r.stack&&(e.stack=r.stack),r.cause&&!e.cause&&(e.cause=r.cause),r.name&&(e.name=r.name),e}}catch(e){}try{return new Error(JSON.stringify(r))}catch(e){}}return new Error(r)};var u=class extends Error{},M=class r extends u{constructor(e,t,s,n){super(`${r.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.requestID=n==null?void 0:n.get("request-id"),this.error=t}static makeMessage(e,t,s){let n=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new z({message:s,cause:Ae(t)});let i=t;return e===400?new he(e,i,s,n):e===401?new fe(e,i,s,n):e===403?new pe(e,i,s,n):e===404?new me(e,i,s,n):e===409?new ge(e,i,s,n):e===422?new ye(e,i,s,n):e===429?new we(e,i,s,n):e>=500?new be(e,i,s,n):new r(e,i,s,n)}},x=class extends M{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},z=class extends M{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},ue=class extends z{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},he=class extends M{},fe=class extends M{},pe=class extends M{},me=class extends M{},ge=class extends M{},ye=class extends M{},we=class extends M{},be=class extends M{};var Nn=/^[a-z][a-z0-9+.-]*:/i,ks=r=>Nn.test(r);function Ut(r){return typeof r!="object"?{}:r!=null?r:{}}function Ts(r){if(!r)return!0;for(let e in r)return!1;return!0}function As(r,e){return Object.prototype.hasOwnProperty.call(r,e)}var Rs=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new u(`${r} must be an integer`);if(e<0)throw new u(`${r} must be a positive integer`);return e};var Xe=r=>{try{return JSON.parse(r)}catch(e){return}};var Cs=r=>new Promise(e=>setTimeout(e,r));var Ye={off:0,error:200,warn:300,info:400,debug:500},Wt=(r,e,t)=>{if(r){if(As(Ye,r))return r;E(t).warn(`${e} was set to ${JSON.stringify(r)}, expected one of ${JSON.stringify(Object.keys(Ye))}`)}};function Re(){}function Ge(r,e,t){return!e||Ye[r]>Ye[t]?Re:e[r].bind(e)}var In={error:Re,warn:Re,info:Re,debug:Re},Ns=new WeakMap;function E(r){var i;let e=r.logger,t=(i=r.logLevel)!=null?i:"off";if(!e)return In;let s=Ns.get(e);if(s&&s[0]===t)return s[1];let n={error:Ge("error",e,t),warn:Ge("warn",e,t),info:Ge("info",e,t),debug:Ge("debug",e,t)};return Ns.set(e,[t,n]),n}var W=r=>(r.options&&(r.options={...r.options},delete r.options.headers),r.headers&&(r.headers=Object.fromEntries((r.headers instanceof Headers?[...r.headers]:Object.entries(r.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in r&&(r.retryOfRequestLogID&&(r.retryOf=r.retryOfRequestLogID),delete r.retryOfRequestLogID),r);var K="0.52.0";var Os=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined";function Ln(){return typeof Deno!="undefined"&&Deno.build!=null?"deno":typeof EdgeRuntime!="undefined"?"edge":Object.prototype.toString.call(typeof globalThis.process!="undefined"?globalThis.process:0)==="[object process]"?"node":"unknown"}var On=()=>{var t,s;let r=Ln();if(r==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":K,"X-Stainless-OS":Ls(Deno.build.os),"X-Stainless-Arch":Is(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(s=(t=Deno.version)==null?void 0:t.deno)!=null?s:"unknown"};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":K,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(r==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":K,"X-Stainless-OS":Ls(globalThis.process.platform),"X-Stainless-Arch":Is(globalThis.process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version};let e=Dn();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":K,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":K,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Dn(){if(typeof navigator=="undefined"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let s=t.exec(navigator.userAgent);if(s){let n=s[1]||0,i=s[2]||0,o=s[3]||0;return{browser:e,version:`${n}.${i}.${o}`}}}return null}var Is=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",Ls=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),Qe,Ds=()=>Qe!=null?Qe:Qe=On();function Bs(){if(typeof fetch!="undefined")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function jt(...r){let e=globalThis.ReadableStream;if(typeof e=="undefined")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...r)}function Ze(r){let e=Symbol.asyncIterator in r?r[Symbol.asyncIterator]():r[Symbol.iterator]();return jt({start(){},async pull(t){let{done:s,value:n}=await e.next();s?t.close():t.enqueue(n)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function Ce(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function $s(r){var s,n;if(r===null||typeof r!="object")return;if(r[Symbol.asyncIterator]){await((n=(s=r[Symbol.asyncIterator]()).return)==null?void 0:n.call(s));return}let e=r.getReader(),t=e.cancel();e.releaseLock(),await t}var Fs=({headers:r,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});function Us(r){let e=0;for(let n of r)e+=n.length;let t=new Uint8Array(e),s=0;for(let n of r)t.set(n,s),s+=n.length;return t}var et;function Ne(r){let e;return(et!=null?et:(e=new globalThis.TextEncoder,et=e.encode.bind(e)))(r)}var tt;function Ht(r){let e;return(tt!=null?tt:(e=new globalThis.TextDecoder,tt=e.decode.bind(e)))(r)}var P,k,j=class{constructor(){P.set(this,void 0),k.set(this,void 0),f(this,P,new Uint8Array,"f"),f(this,k,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Ne(e):e;f(this,P,Us([l(this,P,"f"),t]),"f");let s=[],n;for(;(n=Fn(l(this,P,"f"),l(this,k,"f")))!=null;){if(n.carriage&&l(this,k,"f")==null){f(this,k,n.index,"f");continue}if(l(this,k,"f")!=null&&(n.index!==l(this,k,"f")+1||n.carriage)){s.push(Ht(l(this,P,"f").subarray(0,l(this,k,"f")-1))),f(this,P,l(this,P,"f").subarray(l(this,k,"f")),"f"),f(this,k,null,"f");continue}let i=l(this,k,"f")!==null?n.preceding-1:n.preceding,o=Ht(l(this,P,"f").subarray(0,i));s.push(o),f(this,P,l(this,P,"f").subarray(n.index),"f"),f(this,k,null,"f")}return s}flush(){return l(this,P,"f").length?this.decode(`
`):[]}};P=new WeakMap,k=new WeakMap;j.NEWLINE_CHARS=new Set([`
`,"\r"]);j.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Fn(r,e){for(let n=e!=null?e:0;n<r.length;n++){if(r[n]===10)return{preceding:n,index:n+1,carriage:!1};if(r[n]===13)return{preceding:n,index:n+1,carriage:!0}}return null}function Ws(r){for(let s=0;s<r.length-1;s++){if(r[s]===10&&r[s+1]===10||r[s]===13&&r[s+1]===13)return s+2;if(r[s]===13&&r[s+1]===10&&s+3<r.length&&r[s+2]===13&&r[s+3]===10)return s+4}return-1}var O=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;async function*n(){var o;if(s)throw new u("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let i=!1;try{for await(let a of Un(e,t)){if(a.event==="completion")try{yield JSON.parse(a.data)}catch(c){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),c}if(a.event==="message_start"||a.event==="message_delta"||a.event==="message_stop"||a.event==="content_block_start"||a.event==="content_block_delta"||a.event==="content_block_stop")try{yield JSON.parse(a.data)}catch(c){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),c}if(a.event!=="ping"&&a.event==="error")throw new M(void 0,(o=Xe(a.data))!=null?o:a.data,void 0,e.headers)}i=!0}catch(a){if(U(a))return;throw a}finally{i||t.abort()}}return new r(n,t)}static fromReadableStream(e,t){let s=!1;async function*n(){let o=new j,a=Ce(e);for await(let c of a)for(let d of o.decode(c))yield d;for(let c of o.flush())yield c}async function*i(){if(s)throw new u("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let a of n())o||a&&(yield JSON.parse(a));o=!0}catch(a){if(U(a))return;throw a}finally{o||t.abort()}}return new r(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],s=this.iterator(),n=i=>({next:()=>{if(i.length===0){let o=s.next();e.push(o),t.push(o)}return i.shift()}});return[new r(()=>n(e),this.controller),new r(()=>n(t),this.controller)]}toReadableStream(){let e=this,t;return jt({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{let{value:n,done:i}=await t.next();if(i)return s.close();let o=Ne(JSON.stringify(n)+`
`);s.enqueue(o)}catch(n){s.error(n)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}};async function*Un(r,e){if(!r.body)throw e.abort(),typeof globalThis.navigator!="undefined"&&globalThis.navigator.product==="ReactNative"?new u("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new u("Attempted to iterate over a response with no body");let t=new Vt,s=new j,n=Ce(r.body);for await(let i of Wn(n))for(let o of s.decode(i)){let a=t.decode(o);a&&(yield a)}for(let i of s.flush()){let o=t.decode(i);o&&(yield o)}}async function*Wn(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Ne(t):t,n=new Uint8Array(e.length+s.length);n.set(e),n.set(s,e.length),e=n;let i;for(;(i=Ws(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var Vt=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=jn(e,":");return n.startsWith(" ")&&(n=n.substring(1)),t==="event"?this.event=n:t==="data"&&this.data.push(n),null}};function jn(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}async function st(r,e){let{response:t,requestLogID:s,retryOfRequestLogID:n,startTime:i}=e,o=await(async()=>{var m;if(e.options.stream)return E(r).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):O.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let a=t.headers.get("content-type"),c=(m=a==null?void 0:a.split(";")[0])==null?void 0:m.trim();if((c==null?void 0:c.includes("application/json"))||(c==null?void 0:c.endsWith("+json"))){let y=await t.json();return qt(y,t)}return await t.text()})();return E(r).debug(`[${s}] response parsed`,W({retryOfRequestLogID:n,url:t.url,status:t.status,body:o,durationMs:Date.now()-i})),o}function qt(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var Ie,ne=class r extends Promise{constructor(e,t,s=st){super(n=>{n(null)}),this.responsePromise=t,this.parseResponse=s,Ie.set(this,void 0),f(this,Ie,e,"f")}_thenUnwrap(e){return new r(l(this,Ie,"f"),this.responsePromise,async(t,s)=>qt(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(l(this,Ie,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};Ie=new WeakMap;var nt,zt=class{constructor(e,t,s,n){nt.set(this,void 0),f(this,nt,e,"f"),this.options=n,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new u("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await l(this,nt,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(nt=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Le=class extends ne{constructor(e,t,s){super(e,t,async(n,i)=>new s(n,i.response,await st(n,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},R=class extends zt{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var t;if((t=this.options.query)!=null&&t.before_id){let s=this.first_id;return s?{...this.options,query:{...Ut(this.options.query),before_id:s}}:null}let e=this.last_id;return e?{...this.options,query:{...Ut(this.options.query),after_id:e}}:null}};var Jt=()=>{var r;if(typeof File=="undefined"){let{process:e}=globalThis,t=typeof((r=e==null?void 0:e.versions)==null?void 0:r.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function re(r,e,t){return Jt(),new File(r,e!=null?e:"unknown_file",t)}function Oe(r){return(typeof r=="object"&&r!==null&&("name"in r&&r.name&&String(r.name)||"url"in r&&r.url&&String(r.url)||"filename"in r&&r.filename&&String(r.filename)||"path"in r&&r.path&&String(r.path))||"").split(/[\\/]/).pop()||void 0}var Xt=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function";var Hs=async(r,e)=>({...r,body:await qn(r.body,e)}),js=new WeakMap;function Vn(r){let e=typeof r=="function"?r:r.fetch,t=js.get(e);if(t)return t;let s=(async()=>{try{let n="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new n(i).text()}catch(n){return!0}})();return js.set(e,s),s}var qn=async(r,e)=>{if(!await Vn(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(r||{}).map(([s,n])=>Kt(t,s,n))),t},zn=r=>r instanceof Blob&&"name"in r;var Kt=async(r,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")r.append(e,String(t));else if(t instanceof Response){let s={},n=t.headers.get("Content-Type");n&&(s={type:n}),r.append(e,re([await t.blob()],Oe(t),s))}else if(Xt(t))r.append(e,re([await new Response(Ze(t)).blob()],Oe(t)));else if(zn(t))r.append(e,re([t],Oe(t),{type:t.type}));else if(Array.isArray(t))await Promise.all(t.map(s=>Kt(r,e+"[]",s)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([s,n])=>Kt(r,`${e}[${s}]`,n)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Vs=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function",Kn=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&Vs(r),Jn=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function";async function rt(r,e,t){if(Jt(),r=await r,e||(e=Oe(r)),Kn(r))return r instanceof File&&e==null&&t==null?r:re([await r.arrayBuffer()],e!=null?e:r.name,{type:r.type,lastModified:r.lastModified,...t});if(Jn(r)){let n=await r.blob();return e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()),re(await Gt(n),e,t)}let s=await Gt(r);if(!(t!=null&&t.type)){let n=s.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof n=="string"&&(t={...t,type:n})}return re(s,e,t)}async function Gt(r){var t;let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(Vs(r))e.push(r instanceof Blob?r:await r.arrayBuffer());else if(Xt(r))for await(let s of r)e.push(...await Gt(s));else{let s=(t=r==null?void 0:r.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof r}${s?`; constructor: ${s}`:""}${Xn(r)}`)}return e}function Xn(r){return typeof r!="object"||r===null?"":`; props: [${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}var S=class{constructor(e){this._client=e}};var zs=Symbol.for("brand.privateNullableHeaders"),qs=Array.isArray;function*Yn(r){if(!r)return;if(zs in r){let{values:s,nulls:n}=r;yield*s.entries();for(let i of n)yield[i,null];return}let e=!1,t;r instanceof Headers?t=r.entries():qs(r)?t=r:(e=!0,t=Object.entries(r!=null?r:{}));for(let s of t){let n=s[0];if(typeof n!="string")throw new TypeError("expected header name to be a string");let i=qs(s[1])?s[1]:[s[1]],o=!1;for(let a of i)a!==void 0&&(e&&!o&&(o=!0,yield[n,null]),yield[n,a])}}var g=r=>{let e=new Headers,t=new Set;for(let s of r){let n=new Set;for(let[i,o]of Yn(s)){let a=i.toLowerCase();n.has(a)||(e.delete(i),n.add(a)),o===null?(e.delete(i),t.add(a)):(e.append(i,o),t.delete(a))}}return{[zs]:!0,values:e,nulls:t}};function Ks(r){return r.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var Qn=(r=Ks)=>function(t,...s){if(t.length===1)return t[0];let n=!1,i=t.reduce((p,m,y)=>(/[?#]/.test(m)&&(n=!0),p+m+(y===s.length?"":(n?encodeURIComponent:r)(String(s[y])))),""),o=i.split(/[?#]/,1)[0],a=[],c=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,d;for(;(d=c.exec(o))!==null;)a.push({start:d.index,length:d[0].length});if(a.length>0){let p=0,m=a.reduce((y,h)=>{let _=" ".repeat(h.start-p),$="^".repeat(h.length);return p=h.start+h.length,y+_+$},"");throw new u(`Path parameters result in path with invalid segments:
${i}
${m}`)}return i},v=Qn(Ks);var _e=class extends S{list(e={},t){let{betas:s,...n}=e!=null?e:{};return this._client.getAPIList("/v1/files",R,{query:n,...t,headers:g([{"anthropic-beta":[...s!=null?s:[],"files-api-2025-04-14"].toString()},t==null?void 0:t.headers])})}delete(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.delete(v`/v1/files/${e}`,{...s,headers:g([{"anthropic-beta":[...n!=null?n:[],"files-api-2025-04-14"].toString()},s==null?void 0:s.headers])})}download(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.get(v`/v1/files/${e}/content`,{...s,headers:g([{"anthropic-beta":[...n!=null?n:[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},s==null?void 0:s.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.get(v`/v1/files/${e}`,{...s,headers:g([{"anthropic-beta":[...n!=null?n:[],"files-api-2025-04-14"].toString()},s==null?void 0:s.headers])})}upload(e,t){let{betas:s,...n}=e;return this._client.post("/v1/files",Hs({body:n,...t,headers:g([{"anthropic-beta":[...s!=null?s:[],"files-api-2025-04-14"].toString()},t==null?void 0:t.headers])},this._client))}};var Se=class extends S{retrieve(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.get(v`/v1/models/${e}?beta=true`,{...s,headers:g([{...(n==null?void 0:n.toString())!=null?{"anthropic-beta":n==null?void 0:n.toString()}:void 0},s==null?void 0:s.headers])})}list(e={},t){let{betas:s,...n}=e!=null?e:{};return this._client.getAPIList("/v1/models?beta=true",R,{query:n,...t,headers:g([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers])})}};var Me=class r{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new j;for await(let t of this.iterator)for(let s of e.decode(t))yield JSON.parse(s);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator!="undefined"&&globalThis.navigator.product==="ReactNative"?new u("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new u("Attempted to iterate over a response with no body");return new r(Ce(e.body),t)}};var xe=class extends S{create(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/batches?beta=true",{body:n,...t,headers:g([{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString()},t==null?void 0:t.headers])})}retrieve(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.get(v`/v1/messages/batches/${e}?beta=true`,{...s,headers:g([{"anthropic-beta":[...n!=null?n:[],"message-batches-2024-09-24"].toString()},s==null?void 0:s.headers])})}list(e={},t){let{betas:s,...n}=e!=null?e:{};return this._client.getAPIList("/v1/messages/batches?beta=true",R,{query:n,...t,headers:g([{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString()},t==null?void 0:t.headers])})}delete(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.delete(v`/v1/messages/batches/${e}?beta=true`,{...s,headers:g([{"anthropic-beta":[...n!=null?n:[],"message-batches-2024-09-24"].toString()},s==null?void 0:s.headers])})}cancel(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.post(v`/v1/messages/batches/${e}/cancel?beta=true`,{...s,headers:g([{"anthropic-beta":[...n!=null?n:[],"message-batches-2024-09-24"].toString()},s==null?void 0:s.headers])})}async results(e,t={},s){let n=await this.retrieve(e);if(!n.results_url)throw new u(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);let{betas:i}=t!=null?t:{};return this._client.get(n.results_url,{...s,headers:g([{"anthropic-beta":[...i!=null?i:[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},s==null?void 0:s.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((o,a)=>Me.fromResponse(a.response,a.controller))}};var sr=r=>{let e=0,t=[];for(;e<r.length;){let s=r[e];if(s==="\\"){e++;continue}if(s==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(s==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(s==="["){t.push({type:"paren",value:"["}),e++;continue}if(s==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(s===":"){t.push({type:"separator",value:":"}),e++;continue}if(s===","){t.push({type:"delimiter",value:","}),e++;continue}if(s==='"'){let a="",c=!1;for(s=r[++e];s!=='"';){if(e===r.length){c=!0;break}if(s==="\\"){if(e++,e===r.length){c=!0;break}a+=s+r[e],s=r[++e]}else a+=s,s=r[++e]}s=r[++e],c||t.push({type:"string",value:a});continue}if(s&&/\s/.test(s)){e++;continue}let i=/[0-9]/;if(s&&i.test(s)||s==="-"||s==="."){let a="";for(s==="-"&&(a+=s,s=r[++e]);s&&i.test(s)||s===".";)a+=s,s=r[++e];t.push({type:"number",value:a});continue}let o=/[a-z]/i;if(s&&o.test(s)){let a="";for(;s&&o.test(s)&&e!==r.length;)a+=s,s=r[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},Ee=r=>{if(r.length===0)return r;let e=r[r.length-1];switch(e.type){case"separator":return r=r.slice(0,r.length-1),Ee(r);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return r=r.slice(0,r.length-1),Ee(r);case"string":let s=r[r.length-2];if((s==null?void 0:s.type)==="delimiter")return r=r.slice(0,r.length-1),Ee(r);if((s==null?void 0:s.type)==="brace"&&s.value==="{")return r=r.slice(0,r.length-1),Ee(r);break;case"delimiter":return r=r.slice(0,r.length-1),Ee(r);break}return r},nr=r=>{let e=[];return r.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?r.push({type:"brace",value:"}"}):t==="]"&&r.push({type:"paren",value:"]"})}),r},rr=r=>{let e="";return r.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},it=r=>JSON.parse(rr(nr(Ee(sr(r)))));var C,J,De,ot,Be,$e,at,Fe,H,Ue,lt,ct,ve,dt,ut,Yt,Js,Qt,Zt,es,ts,Xs,Gs="__json_buf",ht=class r{constructor(){C.add(this),this.messages=[],this.receivedMessages=[],J.set(this,void 0),this.controller=new AbortController,De.set(this,void 0),ot.set(this,()=>{}),Be.set(this,()=>{}),$e.set(this,void 0),at.set(this,()=>{}),Fe.set(this,()=>{}),H.set(this,{}),Ue.set(this,!1),lt.set(this,!1),ct.set(this,!1),ve.set(this,!1),dt.set(this,void 0),ut.set(this,void 0),Qt.set(this,e=>{if(f(this,lt,!0,"f"),U(e)&&(e=new x),e instanceof x)return f(this,ct,!0,"f"),this._emit("abort",e);if(e instanceof u)return this._emit("error",e);if(e instanceof Error){let t=new u(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new u(String(e)))}),f(this,De,new Promise((e,t)=>{f(this,ot,e,"f"),f(this,Be,t,"f")}),"f"),f(this,$e,new Promise((e,t)=>{f(this,at,e,"f"),f(this,Fe,t,"f")}),"f"),l(this,De,"f").catch(()=>{}),l(this,$e,"f").catch(()=>{})}get response(){return l(this,dt,"f")}get request_id(){return l(this,ut,"f")}async withResponse(){let e=await l(this,De,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let i of t.messages)n._addMessageParam(i);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,Qt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){var a;let n=s==null?void 0:s.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),l(this,C,"m",Zt).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(i);for await(let c of o)l(this,C,"m",es).call(this,c);if((a=o.controller.signal)!=null&&a.aborted)throw new x;l(this,C,"m",ts).call(this)}_connected(e){this.ended||(f(this,dt,e,"f"),f(this,ut,e==null?void 0:e.headers.get("request-id"),"f"),l(this,ot,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,Ue,"f")}get errored(){return l(this,lt,"f")}get aborted(){return l(this,ct,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,H,"f")[e]||(l(this,H,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=l(this,H,"f")[e];if(!s)return this;let n=s.findIndex(i=>i.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(l(this,H,"f")[e]||(l(this,H,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{f(this,ve,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){f(this,ve,!0,"f"),await l(this,$e,"f")}get currentMessage(){return l(this,J,"f")}async finalMessage(){return await this.done(),l(this,C,"m",Yt).call(this)}async finalText(){return await this.done(),l(this,C,"m",Js).call(this)}_emit(e,...t){if(l(this,Ue,"f"))return;e==="end"&&(f(this,Ue,!0,"f"),l(this,at,"f").call(this));let s=l(this,H,"f")[e];if(s&&(l(this,H,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!l(this,ve,"f")&&!(s!=null&&s.length)&&Promise.reject(n),l(this,Be,"f").call(this,n),l(this,Fe,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!l(this,ve,"f")&&!(s!=null&&s.length)&&Promise.reject(n),l(this,Be,"f").call(this,n),l(this,Fe,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,C,"m",Yt).call(this))}async _fromReadableStream(e,t){var i;let s=t==null?void 0:t.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,C,"m",Zt).call(this),this._connected(null);let n=O.fromReadableStream(e,this.controller);for await(let o of n)l(this,C,"m",es).call(this,o);if((i=n.controller.signal)!=null&&i.aborted)throw new x;l(this,C,"m",ts).call(this)}[(J=new WeakMap,De=new WeakMap,ot=new WeakMap,Be=new WeakMap,$e=new WeakMap,at=new WeakMap,Fe=new WeakMap,H=new WeakMap,Ue=new WeakMap,lt=new WeakMap,ct=new WeakMap,ve=new WeakMap,dt=new WeakMap,ut=new WeakMap,Qt=new WeakMap,C=new WeakSet,Yt=function(){if(this.receivedMessages.length===0)throw new u("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Js=function(){if(this.receivedMessages.length===0)throw new u("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new u("stream ended without producing a content block with type=text");return t.join(" ")},Zt=function(){this.ended||f(this,J,void 0,"f")},es=function(t){var n;if(this.ended)return;let s=l(this,C,"m",Xs).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let i=s.content.at(-1);switch(t.delta.type){case"text_delta":{i.type==="text"&&this._emit("text",t.delta.text,i.text||"");break}case"citations_delta":{i.type==="text"&&this._emit("citation",t.delta.citation,(n=i.citations)!=null?n:[]);break}case"input_json_delta":{(i.type==="tool_use"||i.type==="mcp_tool_use")&&i.input&&this._emit("inputJson",t.delta.partial_json,i.input);break}case"thinking_delta":{i.type==="thinking"&&this._emit("thinking",t.delta.thinking,i.thinking);break}case"signature_delta":{i.type==="thinking"&&this._emit("signature",i.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{f(this,J,s,"f");break}case"content_block_start":case"message_delta":break}},ts=function(){if(this.ended)throw new u("stream has ended, this shouldn't happen");let t=l(this,J,"f");if(!t)throw new u("request ended without sending any chunks");return f(this,J,void 0,"f"),t},Xs=function(t){var n;let s=l(this,J,"f");if(t.type==="message_start"){if(s)throw new u(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new u(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.container=t.delta.container,s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(s.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(s.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(s.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(s.usage.server_tool_use=t.usage.server_tool_use),s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let i=s.content.at(t.index);switch(t.delta.type){case"text_delta":{(i==null?void 0:i.type)==="text"&&(i.text+=t.delta.text);break}case"citations_delta":{(i==null?void 0:i.type)==="text"&&((n=i.citations)!=null||(i.citations=[]),i.citations.push(t.delta.citation));break}case"input_json_delta":{if((i==null?void 0:i.type)==="tool_use"||(i==null?void 0:i.type)==="mcp_tool_use"){let o=i[Gs]||"";o+=t.delta.partial_json,Object.defineProperty(i,Gs,{value:o,enumerable:!1,writable:!0}),o&&(i.input=it(o))}break}case"thinking_delta":{(i==null?void 0:i.type)==="thinking"&&(i.thinking+=t.delta.thinking);break}case"signature_delta":{(i==null?void 0:i.type)==="thinking"&&(i.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let i=t.shift();i?i.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new O(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var ft={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192};var Ys={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"},ie=class extends S{constructor(){super(...arguments),this.batches=new xe(this._client)}create(e,t){var o,a;let{betas:s,...n}=e;n.model in Ys&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${Ys[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let i=this._client._options.timeout;if(!n.stream&&i==null){let c=(o=ft[n.model])!=null?o:void 0;i=this._client.calculateNonstreamingTimeout(n.max_tokens,c)}return this._client.post("/v1/messages?beta=true",{body:n,timeout:i!=null?i:6e5,...t,headers:g([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers]),stream:(a=e.stream)!=null?a:!1})}stream(e,t){return ht.createMessage(this,e,t)}countTokens(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:n,...t,headers:g([{"anthropic-beta":[...s!=null?s:[],"token-counting-2024-11-01"].toString()},t==null?void 0:t.headers])})}};ie.Batches=xe;var D=class extends S{constructor(){super(...arguments),this.models=new Se(this._client),this.messages=new ie(this._client),this.files=new _e(this._client)}};D.Models=Se;D.Messages=ie;D.Files=_e;var oe=class extends S{create(e,t){var i,o;let{betas:s,...n}=e;return this._client.post("/v1/complete",{body:n,timeout:(i=this._client._options.timeout)!=null?i:6e5,...t,headers:g([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers]),stream:(o=e.stream)!=null?o:!1})}};var N,X,We,pt,je,He,mt,Ve,V,qe,gt,yt,Pe,wt,bt,ss,Qs,ns,rs,is,os,Zs,en="__json_buf",_t=class r{constructor(){N.add(this),this.messages=[],this.receivedMessages=[],X.set(this,void 0),this.controller=new AbortController,We.set(this,void 0),pt.set(this,()=>{}),je.set(this,()=>{}),He.set(this,void 0),mt.set(this,()=>{}),Ve.set(this,()=>{}),V.set(this,{}),qe.set(this,!1),gt.set(this,!1),yt.set(this,!1),Pe.set(this,!1),wt.set(this,void 0),bt.set(this,void 0),ns.set(this,e=>{if(f(this,gt,!0,"f"),U(e)&&(e=new x),e instanceof x)return f(this,yt,!0,"f"),this._emit("abort",e);if(e instanceof u)return this._emit("error",e);if(e instanceof Error){let t=new u(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new u(String(e)))}),f(this,We,new Promise((e,t)=>{f(this,pt,e,"f"),f(this,je,t,"f")}),"f"),f(this,He,new Promise((e,t)=>{f(this,mt,e,"f"),f(this,Ve,t,"f")}),"f"),l(this,We,"f").catch(()=>{}),l(this,He,"f").catch(()=>{})}get response(){return l(this,wt,"f")}get request_id(){return l(this,bt,"f")}async withResponse(){let e=await l(this,We,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let i of t.messages)n._addMessageParam(i);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,ns,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){var a;let n=s==null?void 0:s.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),l(this,N,"m",rs).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(i);for await(let c of o)l(this,N,"m",is).call(this,c);if((a=o.controller.signal)!=null&&a.aborted)throw new x;l(this,N,"m",os).call(this)}_connected(e){this.ended||(f(this,wt,e,"f"),f(this,bt,e==null?void 0:e.headers.get("request-id"),"f"),l(this,pt,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,qe,"f")}get errored(){return l(this,gt,"f")}get aborted(){return l(this,yt,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,V,"f")[e]||(l(this,V,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=l(this,V,"f")[e];if(!s)return this;let n=s.findIndex(i=>i.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(l(this,V,"f")[e]||(l(this,V,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{f(this,Pe,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){f(this,Pe,!0,"f"),await l(this,He,"f")}get currentMessage(){return l(this,X,"f")}async finalMessage(){return await this.done(),l(this,N,"m",ss).call(this)}async finalText(){return await this.done(),l(this,N,"m",Qs).call(this)}_emit(e,...t){if(l(this,qe,"f"))return;e==="end"&&(f(this,qe,!0,"f"),l(this,mt,"f").call(this));let s=l(this,V,"f")[e];if(s&&(l(this,V,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!l(this,Pe,"f")&&!(s!=null&&s.length)&&Promise.reject(n),l(this,je,"f").call(this,n),l(this,Ve,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!l(this,Pe,"f")&&!(s!=null&&s.length)&&Promise.reject(n),l(this,je,"f").call(this,n),l(this,Ve,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,N,"m",ss).call(this))}async _fromReadableStream(e,t){var i;let s=t==null?void 0:t.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,N,"m",rs).call(this),this._connected(null);let n=O.fromReadableStream(e,this.controller);for await(let o of n)l(this,N,"m",is).call(this,o);if((i=n.controller.signal)!=null&&i.aborted)throw new x;l(this,N,"m",os).call(this)}[(X=new WeakMap,We=new WeakMap,pt=new WeakMap,je=new WeakMap,He=new WeakMap,mt=new WeakMap,Ve=new WeakMap,V=new WeakMap,qe=new WeakMap,gt=new WeakMap,yt=new WeakMap,Pe=new WeakMap,wt=new WeakMap,bt=new WeakMap,ns=new WeakMap,N=new WeakSet,ss=function(){if(this.receivedMessages.length===0)throw new u("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Qs=function(){if(this.receivedMessages.length===0)throw new u("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new u("stream ended without producing a content block with type=text");return t.join(" ")},rs=function(){this.ended||f(this,X,void 0,"f")},is=function(t){var n;if(this.ended)return;let s=l(this,N,"m",Zs).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let i=s.content.at(-1);switch(t.delta.type){case"text_delta":{i.type==="text"&&this._emit("text",t.delta.text,i.text||"");break}case"citations_delta":{i.type==="text"&&this._emit("citation",t.delta.citation,(n=i.citations)!=null?n:[]);break}case"input_json_delta":{i.type==="tool_use"&&i.input&&this._emit("inputJson",t.delta.partial_json,i.input);break}case"thinking_delta":{i.type==="thinking"&&this._emit("thinking",t.delta.thinking,i.thinking);break}case"signature_delta":{i.type==="thinking"&&this._emit("signature",i.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{f(this,X,s,"f");break}case"content_block_start":case"message_delta":break}},os=function(){if(this.ended)throw new u("stream has ended, this shouldn't happen");let t=l(this,X,"f");if(!t)throw new u("request ended without sending any chunks");return f(this,X,void 0,"f"),t},Zs=function(t){var n;let s=l(this,X,"f");if(t.type==="message_start"){if(s)throw new u(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new u(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(s.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(s.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(s.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(s.usage.server_tool_use=t.usage.server_tool_use),s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let i=s.content.at(t.index);switch(t.delta.type){case"text_delta":{(i==null?void 0:i.type)==="text"&&(i.text+=t.delta.text);break}case"citations_delta":{(i==null?void 0:i.type)==="text"&&((n=i.citations)!=null||(i.citations=[]),i.citations.push(t.delta.citation));break}case"input_json_delta":{if((i==null?void 0:i.type)==="tool_use"){let o=i[en]||"";o+=t.delta.partial_json,Object.defineProperty(i,en,{value:o,enumerable:!1,writable:!0}),o&&(i.input=it(o))}break}case"thinking_delta":{(i==null?void 0:i.type)==="thinking"&&(i.thinking+=t.delta.thinking);break}case"signature_delta":{(i==null?void 0:i.type)==="thinking"&&(i.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let i=t.shift();i?i.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new O(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var ke=class extends S{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(v`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",R,{query:e,...t})}delete(e,t){return this._client.delete(v`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(v`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let s=await this.retrieve(e);if(!s.results_url)throw new u(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...t,headers:g([{Accept:"application/binary"},t==null?void 0:t.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((n,i)=>Me.fromResponse(i.response,i.controller))}};var G=class extends S{constructor(){super(...arguments),this.batches=new ke(this._client)}create(e,t){var n,i;e.model in tn&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${tn[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let s=this._client._options.timeout;if(!e.stream&&s==null){let o=(n=ft[e.model])!=null?n:void 0;s=this._client.calculateNonstreamingTimeout(e.max_tokens,o)}return this._client.post("/v1/messages",{body:e,timeout:s!=null?s:6e5,...t,stream:(i=e.stream)!=null?i:!1})}stream(e,t){return _t.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},tn={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};G.Batches=ke;var ae=class extends S{retrieve(e,t={},s){let{betas:n}=t!=null?t:{};return this._client.get(v`/v1/models/${e}`,{...s,headers:g([{...(n==null?void 0:n.toString())!=null?{"anthropic-beta":n==null?void 0:n.toString()}:void 0},s==null?void 0:s.headers])})}list(e={},t){let{betas:s,...n}=e!=null?e:{};return this._client.getAPIList("/v1/models",R,{query:n,...t,headers:g([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers])})}};var ze=r=>{var e,t,s,n,i,o;if(typeof globalThis.process!="undefined")return(s=(t=(e=globalThis.process.env)==null?void 0:e[r])==null?void 0:t.trim())!=null?s:void 0;if(typeof globalThis.Deno!="undefined")return(o=(i=(n=globalThis.Deno.env)==null?void 0:n.get)==null?void 0:i.call(n,r))==null?void 0:o.trim()};var sn,St,w=class{constructor({baseURL:e=ze("ANTHROPIC_BASE_URL"),apiKey:t=(i=>(i=ze("ANTHROPIC_API_KEY"))!=null?i:null)(),authToken:s=(o=>(o=ze("ANTHROPIC_AUTH_TOKEN"))!=null?o:null)(),...n}={}){var d,p,m,y,h,_;St.set(this,void 0);let a={apiKey:t,authToken:s,...n,baseURL:e||"https://api.anthropic.com"};if(!a.dangerouslyAllowBrowser&&Os())throw new u(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);this.baseURL=a.baseURL,this.timeout=(d=a.timeout)!=null?d:T.DEFAULT_TIMEOUT,this.logger=(p=a.logger)!=null?p:console;let c="warn";this.logLevel=c,this.logLevel=(y=(m=Wt(a.logLevel,"ClientOptions.logLevel",this))!=null?m:Wt(ze("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this))!=null?y:c,this.fetchOptions=a.fetchOptions,this.maxRetries=(h=a.maxRetries)!=null?h:2,this.fetch=(_=a.fetch)!=null?_:Bs(),f(this,St,Fs,"f"),this._options=a,this.apiKey=t,this.authToken=s}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(this.apiKey&&e.get("x-api-key"))&&!t.has("x-api-key")&&!(this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){return g([this.apiKeyAuth(e),this.bearerAuth(e)])}apiKeyAuth(e){if(this.apiKey!=null)return g([{"X-Api-Key":this.apiKey}])}bearerAuth(e){if(this.authToken!=null)return g([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s!="undefined").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new u(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${K}`}defaultIdempotencyKey(){return`stainless-node-retry-${Ft()}`}makeStatusError(e,t,s,n){return M.generate(e,t,s,n)}buildURL(e,t){let s=ks(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return Ts(n)||(t={...n,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new u("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(n=>({method:e,path:t,...n})))}request(e,t=null){return new ne(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){var ce,de,se;let n=await e,i=(ce=n.maxRetries)!=null?ce:this.maxRetries;t==null&&(t=i),await this.prepareOptions(n);let{req:o,url:a,timeout:c}=this.buildRequest(n,{retryCount:i-t});await this.prepareRequest(o,{url:a,options:n});let d="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),p=s===void 0?"":`, retryOf: ${s}`,m=Date.now();if(E(this).debug(`[${d}] sending request`,W({retryOfRequestLogID:s,method:n.method,url:a,options:n,headers:o.headers})),(de=n.signal)!=null&&de.aborted)throw new x;let y=new AbortController,h=await this.fetchWithTimeout(a,o,c,y).catch(Ae),_=Date.now();if(h instanceof Error){let F=`retrying, ${t} attempts remaining`;if((se=n.signal)!=null&&se.aborted)throw new x;let L=U(h)||/timed? ?out/i.test(String(h)+("cause"in h?String(h.cause):""));if(t)return E(this).info(`[${d}] connection ${L?"timed out":"failed"} - ${F}`),E(this).debug(`[${d}] connection ${L?"timed out":"failed"} (${F})`,W({retryOfRequestLogID:s,url:a,durationMs:_-m,message:h.message})),this.retryRequest(n,t,s!=null?s:d);throw E(this).info(`[${d}] connection ${L?"timed out":"failed"} - error; no more retries left`),E(this).debug(`[${d}] connection ${L?"timed out":"failed"} (error; no more retries left)`,W({retryOfRequestLogID:s,url:a,durationMs:_-m,message:h.message})),L?new ue:new z({cause:h})}let $=[...h.headers.entries()].filter(([F])=>F==="request-id").map(([F,L])=>", "+F+": "+JSON.stringify(L)).join(""),te=`[${d}${p}${$}] ${o.method} ${a} ${h.ok?"succeeded":"failed"} with status ${h.status} in ${_-m}ms`;if(!h.ok){let F=this.shouldRetry(h);if(t&&F){let Je=`retrying, ${t} attempts remaining`;return await $s(h.body),E(this).info(`${te} - ${Je}`),E(this).debug(`[${d}] response error (${Je})`,W({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,durationMs:_-m})),this.retryRequest(n,t,s!=null?s:d,h.headers)}let L=F?"error; no more retries left":"error; not retryable";E(this).info(`${te} - ${L}`);let Es=await h.text().catch(Je=>Ae(Je).message),vs=Xe(Es),Ps=vs?void 0:Es;throw E(this).debug(`[${d}] response error (${L})`,W({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,message:Ps,durationMs:Date.now()-m})),this.makeStatusError(h.status,vs,Ps,h.headers)}return E(this).info(te),E(this).debug(`[${d}] response start`,W({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,durationMs:_-m})),{response:h,options:n,controller:y,requestLogID:d,retryOfRequestLogID:s,startTime:m}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){let s=this.makeRequest(t,null,void 0);return new Le(this,s,e)}async fetchWithTimeout(e,t,s,n){let{signal:i,method:o,...a}=t||{};i&&i.addEventListener("abort",()=>n.abort());let c=setTimeout(()=>n.abort(),s),d=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||typeof a.body=="object"&&a.body!==null&&Symbol.asyncIterator in a.body,p={signal:n.signal,...d?{duplex:"half"}:{},method:"GET",...a};o&&(p.method=o.toUpperCase());try{return await this.fetch.call(void 0,e,p)}finally{clearTimeout(c)}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s,n){var c;let i,o=n==null?void 0:n.get("retry-after-ms");if(o){let d=parseFloat(o);Number.isNaN(d)||(i=d)}let a=n==null?void 0:n.get("retry-after");if(a&&!i){let d=parseFloat(a);Number.isNaN(d)?i=Date.parse(a)-Date.now():i=d*1e3}if(!(i&&0<=i&&i<60*1e3)){let d=(c=e.maxRetries)!=null?c:this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,d)}return await Cs(i),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,o=Math.min(.5*Math.pow(2,i),8),a=1-Math.random()*.25;return o*a*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||t!=null&&e>t)throw new u("Streaming is strongly recommended for operations that may token longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}buildRequest(e,{retryCount:t=0}={}){var y,h,_;let s={...e},{method:n,path:i,query:o}=s,a=this.buildURL(i,o);"timeout"in s&&Rs("timeout",s.timeout),s.timeout=(y=s.timeout)!=null?y:this.timeout;let{bodyHeaders:c,body:d}=this.buildBody({options:s}),p=this.buildHeaders({options:e,method:n,bodyHeaders:c,retryCount:t});return{req:{method:n,headers:p,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&d instanceof globalThis.ReadableStream&&{duplex:"half"},...d&&{body:d},...(h=this.fetchOptions)!=null?h:{},...(_=s.fetchOptions)!=null?_:{}},url:a,timeout:s.timeout}}buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:n}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let o=g([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...Ds(),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(o),o.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let s=g([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&s.values.has("content-type")||e instanceof Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Ze(e)}:l(this,St,"f").call(this,{body:e,headers:s})}};sn=w,St=new WeakMap;w.Anthropic=sn;w.HUMAN_PROMPT=`

Human:`;w.AI_PROMPT=`

Assistant:`;w.DEFAULT_TIMEOUT=6e5;w.AnthropicError=u;w.APIError=M;w.APIConnectionError=z;w.APIConnectionTimeoutError=ue;w.APIUserAbortError=x;w.NotFoundError=me;w.ConflictError=ge;w.RateLimitError=we;w.BadRequestError=he;w.AuthenticationError=fe;w.InternalServerError=be;w.PermissionDeniedError=pe;w.UnprocessableEntityError=ye;w.toFile=rt;var T=class extends w{constructor(){super(...arguments),this.completions=new oe(this),this.messages=new G(this),this.models=new ae(this),this.beta=new D(this)}};T.Completions=oe;T.Messages=G;T.Models=ae;T.Beta=D;var{HUMAN_PROMPT:lr,AI_PROMPT:cr}=T;var as=["claude-sonnet-4-20250514","claude-opus-4-20250514","claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022"],Mt=class{constructor(e,t="claude-sonnet-4-20250514"){this.name="Claude";this.client=null;this.stats={tokensThisSession:0,tokensToday:0,lastResponseTime:0,currentContextSize:0};this.model=t,e&&(this.client=new T({apiKey:e,dangerouslyAllowBrowser:!0}))}setApiKey(e){e?this.client=new T({apiKey:e,dangerouslyAllowBrowser:!0}):this.client=null}setModel(e){this.model=e}isConfigured(){return this.client!==null}async listModels(){return as}async chat(e,t,s,n){if(!this.client)throw new Error("Claude API not configured. Please add your API key in settings.");let i=Date.now();this.stats.currentContextSize=t.length;try{let o=this.client.messages.stream({model:this.model,max_tokens:300,system:e,messages:[{role:"user",content:t}]}),a="";o.on("text",d=>{a+=d,s(d)});let c=await o.finalMessage();this.stats.lastResponseTime=Date.now()-i,c.usage&&(this.stats.tokensThisSession+=c.usage.input_tokens+c.usage.output_tokens,this.stats.tokensToday+=c.usage.input_tokens+c.usage.output_tokens),n(a)}catch(o){throw console.error("Claude API error:",o),o}}async generate(e,t){if(!this.client)throw new Error("Claude API not configured. Please add your API key in settings.");let s=Date.now();this.stats.currentContextSize=t.length;try{let n=await this.client.messages.create({model:this.model,max_tokens:100,system:e,messages:[{role:"user",content:t}]});this.stats.lastResponseTime=Date.now()-s,n.usage&&(this.stats.tokensThisSession+=n.usage.input_tokens+n.usage.output_tokens,this.stats.tokensToday+=n.usage.input_tokens+n.usage.output_tokens);let i=n.content.find(o=>o.type==="text");return!i||i.type!=="text"?null:i.text.trim()}catch(n){throw console.error("Claude API error:",n),n}}async testConnection(){if(!this.client)return!1;try{return await this.client.messages.create({model:this.model,max_tokens:10,messages:[{role:"user",content:"Hi"}]}),!0}catch(e){return console.error("Claude connection test failed:",e),!1}}getStats(){return{...this.stats}}resetSessionStats(){this.stats.tokensThisSession=0}};var xt=class extends b.PluginSettingTab{constructor(t,s){super(t,s);this.ollamaModelDropdown=null;this.plugin=s}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"LLM Provider"}),new b.Setting(t).setName("Provider").setDesc("Choose your LLM provider").addDropdown(n=>n.addOption("claude","Claude (Anthropic)").addOption("ollama","Ollama (Local)").setValue(this.plugin.settings.provider).onChange(async i=>{this.plugin.settings.provider=i,await this.plugin.saveSettings(),this.plugin.switchProvider(i),this.display()})),this.plugin.settings.provider==="claude"?this.displayClaudeSettings(t):this.displayOllamaSettings(t),new b.Setting(t).setName("Test Connection").setDesc("Verify connection to the selected provider").addButton(n=>n.setButtonText("Test Connection").onClick(async()=>{n.setDisabled(!0),n.setButtonText("Testing..."),await this.plugin.testConnection()?new b.Notice("Connection successful!"):new b.Notice("Connection failed. Check your settings."),n.setDisabled(!1),n.setButtonText("Test Connection")})),t.createEl("h2",{text:"Behavior"}),new b.Setting(t).setName("Default interaction style").setDesc("How the AI responds by default").addDropdown(n=>n.addOption("muse","Muse (inline responses)").addOption("whisper","Whisper (hover annotations)").addOption("off","Off").setValue(this.plugin.settings.defaultStyle).onChange(async i=>{this.plugin.settings.defaultStyle=i,await this.plugin.saveSettings()})),new b.Setting(t).setName("Default mood").setDesc("The default persona for AI responses").addDropdown(n=>n.addOption("auto","Auto-detect").addOption("reflect","Reflect (journaling)").addOption("think","Think (essays/ideas)").addOption("plan","Plan (todos/planning)").setValue(this.plugin.settings.defaultMood).onChange(async i=>{this.plugin.settings.defaultMood=i,await this.plugin.saveSettings()})),new b.Setting(t).setName("Pause duration").setDesc("How long to wait after typing stops before Muse responds (seconds)").addSlider(n=>n.setLimits(1,5,.5).setValue(this.plugin.settings.pauseDuration).setDynamicTooltip().onChange(async i=>{this.plugin.settings.pauseDuration=i,await this.plugin.saveSettings(),this.plugin.updatePauseDuration(i)})),new b.Setting(t).setName("Enable linked note context").setDesc("Include content from linked notes in AI context").addToggle(n=>n.setValue(this.plugin.settings.enableLinkedNoteContext).onChange(async i=>{this.plugin.settings.enableLinkedNoteContext=i,await this.plugin.saveSettings()})),new b.Setting(t).setName("Linked note depth").setDesc("How many levels of links to include (if linked note context is enabled)").addDropdown(n=>n.addOption("1","1 level").addOption("2","2 levels").addOption("3","3 levels").setValue(this.plugin.settings.linkedNoteDepth.toString()).onChange(async i=>{this.plugin.settings.linkedNoteDepth=parseInt(i),await this.plugin.saveSettings()})),t.createEl("h2",{text:"Keyboard Shortcuts"}),t.createEl("p",{text:"Default shortcuts:",cls:"setting-item-description"});let s=t.createEl("ul",{cls:"setting-item-description"});if(s.createEl("li",{text:"Cmd/Ctrl + Shift + M: Toggle Muse mode"}),s.createEl("li",{text:"Cmd/Ctrl + Shift + W: Toggle Whisper mode"}),new b.Setting(t).setName("Customize shortcuts").setDesc("Open Obsidian's hotkey settings to customize shortcuts").addButton(n=>n.setButtonText("Open Hotkey Settings").onClick(()=>{this.app.setting.openTabById("hotkeys"),this.app.setting.activeTab.searchComponent.inputEl.value="Enchanted Notes",this.app.setting.activeTab.updateHotkeyVisibility()})),t.createEl("h2",{text:"Developer"}),new b.Setting(t).setName("Show developer panel").setDesc("Display token usage and response times").addToggle(n=>n.setValue(this.plugin.settings.showDeveloperPanel).onChange(async i=>{this.plugin.settings.showDeveloperPanel=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.showDeveloperPanel){let n=this.plugin.getStats(),i=t.createDiv({cls:"enchanted-notes-stats"});i.createEl("p",{text:`Tokens this session: ${n.tokensThisSession}`}),i.createEl("p",{text:`Tokens today: ${n.tokensToday}`}),i.createEl("p",{text:`Last response time: ${n.lastResponseTime}ms`}),i.createEl("p",{text:`Current context size: ${n.currentContextSize} chars`}),new b.Setting(t).setName("Reset session stats").addButton(o=>o.setButtonText("Reset").onClick(()=>{this.plugin.resetSessionStats(),this.display()}))}t.createEl("h2",{text:"About"}),t.createEl("p",{text:"Enchanted Notes makes your notes come alive. Write naturally, and AI will respond as your thinking partner.",cls:"setting-item-description"}),t.createEl("p",{text:"Use ::muse[...]:: or :::muse blocks for inline responses, and ::whisper[...]:: for hover annotations.",cls:"setting-item-description"})}displayClaudeSettings(t){new b.Setting(t).setName("Claude API Key").setDesc("Your Anthropic API key. Get one at console.anthropic.com").addText(s=>s.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.claudeApiKey).onChange(async n=>{this.plugin.settings.claudeApiKey=n,await this.plugin.saveSettings(),this.plugin.updateProviderConfig()})),new b.Setting(t).setName("Model").setDesc("The Claude model to use for responses").addDropdown(s=>{for(let n of as){let i=n==="claude-sonnet-4-20250514"?"Claude Sonnet 4 (Recommended)":n==="claude-opus-4-20250514"?"Claude Opus 4":n==="claude-3-5-sonnet-20241022"?"Claude 3.5 Sonnet":"Claude 3.5 Haiku (Faster)";s.addOption(n,i)}s.setValue(this.plugin.settings.claudeModel).onChange(async n=>{this.plugin.settings.claudeModel=n,await this.plugin.saveSettings(),this.plugin.updateProviderConfig()})})}displayOllamaSettings(t){new b.Setting(t).setName("Ollama Base URL").setDesc("The URL where Ollama is running").addText(n=>n.setPlaceholder("http://localhost:11434").setValue(this.plugin.settings.ollamaBaseUrl).onChange(async i=>{this.plugin.settings.ollamaBaseUrl=i,await this.plugin.saveSettings(),this.plugin.updateProviderConfig()}));let s=new b.Setting(t).setName("Model").setDesc("Select an Ollama model (click Refresh to load available models)");s.addDropdown(n=>{this.ollamaModelDropdown=n,this.plugin.settings.ollamaModel?(n.addOption(this.plugin.settings.ollamaModel,this.plugin.settings.ollamaModel),n.setValue(this.plugin.settings.ollamaModel)):(n.addOption("","Select a model..."),n.setValue("")),n.onChange(async i=>{this.plugin.settings.ollamaModel=i,await this.plugin.saveSettings(),this.plugin.updateProviderConfig()})}),s.addButton(n=>n.setButtonText("Refresh Models").onClick(async()=>{n.setDisabled(!0),n.setButtonText("Loading...");try{let i=await this.plugin.fetchOllamaModels();if(this.ollamaModelDropdown)if(this.ollamaModelDropdown.selectEl.empty(),i.length===0)this.ollamaModelDropdown.addOption("","No models found"),new b.Notice("No Ollama models found. Make sure Ollama is running.");else{for(let o of i)this.ollamaModelDropdown.addOption(o,o);i.includes(this.plugin.settings.ollamaModel)?this.ollamaModelDropdown.setValue(this.plugin.settings.ollamaModel):i.length>0&&(this.ollamaModelDropdown.setValue(i[0]),this.plugin.settings.ollamaModel=i[0],await this.plugin.saveSettings(),this.plugin.updateProviderConfig()),new b.Notice(`Found ${i.length} model(s)`)}}catch(i){new b.Notice("Failed to fetch models. Check if Ollama is running."),console.error("Failed to fetch Ollama models:",i)}n.setDisabled(!1),n.setButtonText("Refresh Models")}))}};var ls=require("obsidian"),Et=class{constructor(e="http://localhost:11434",t=""){this.name="Ollama";this.stats={tokensThisSession:0,tokensToday:0,lastResponseTime:0,currentContextSize:0};this.baseUrl=e.replace(/\/$/,""),this.model=t}setBaseUrl(e){this.baseUrl=e.replace(/\/$/,"")}setModel(e){this.model=e}getModel(){return this.model}isConfigured(){return this.baseUrl.length>0&&this.model.length>0}async listModels(){try{return(await(0,ls.requestUrl)({url:`${this.baseUrl}/api/tags`,method:"GET"})).json.models.map(s=>s.name)}catch(e){return console.error("Failed to fetch Ollama models:",e),[]}}async chat(e,t,s,n){var a,c;if(!this.isConfigured())throw new Error("Ollama not configured. Please select a model in settings.");let i=Date.now();this.stats.currentContextSize=t.length;let o=[{role:"system",content:e},{role:"user",content:t}];try{let d=await fetch(`${this.baseUrl}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:o,stream:!0})});if(!d.ok)throw new Error(`Ollama API error: ${d.status} ${d.statusText}`);let p=(a=d.body)==null?void 0:a.getReader();if(!p)throw new Error("No response body");let m=new TextDecoder,y="";for(;;){let{done:_,value:$}=await p.read();if(_)break;let ce=m.decode($,{stream:!0}).split(`
`).filter(de=>de.trim());for(let de of ce)try{let se=JSON.parse(de);(c=se.message)!=null&&c.content&&(y+=se.message.content,s(se.message.content))}catch(se){}}this.stats.lastResponseTime=Date.now()-i;let h=Math.ceil((t.length+y.length)/4);this.stats.tokensThisSession+=h,this.stats.tokensToday+=h,n(y)}catch(d){throw console.error("Ollama API error:",d),d}}async generate(e,t){var i;if(!this.isConfigured())throw new Error("Ollama not configured. Please select a model in settings.");let s=Date.now();this.stats.currentContextSize=t.length;let n=[{role:"system",content:e},{role:"user",content:t}];try{let a=(await(0,ls.requestUrl)({url:`${this.baseUrl}/api/chat`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:n,stream:!1})})).json;this.stats.lastResponseTime=Date.now()-s;let c=((i=a.message)==null?void 0:i.content)||"",d=Math.ceil((t.length+c.length)/4);return this.stats.tokensThisSession+=d,this.stats.tokensToday+=d,c.trim()||null}catch(o){throw console.error("Ollama API error:",o),o}}async testConnection(){try{return(await this.listModels()).length>0}catch(e){return console.error("Ollama connection test failed:",e),!1}}getStats(){return{...this.stats}}resetSessionStats(){this.stats.tokensThisSession=0}};var Y=require("obsidian");var kt=class kt{constructor(e=2){this.pauseTimer=null;this.lastEnterTime=0;this.lastContent="";this.onPauseTrigger=null;this.onDoubleEnterTrigger=null;this.enabled=!1;this.pauseDuration=e*1e3}enable(){this.enabled=!0}disable(){this.enabled=!1,this.clearPauseTimer()}isEnabled(){return this.enabled}setPauseDuration(e){this.pauseDuration=e*1e3}onPause(e){this.onPauseTrigger=e}onDoubleEnter(e){this.onDoubleEnterTrigger=e}handleUpdate(e){return!this.enabled||!e.docChanged?!1:this.checkDoubleEnter(e)?!0:(this.resetPauseTimer(),!1)}checkDoubleEnter(e){let t=!1;if(e.changes.iterChanges((i,o,a,c,d)=>{let p=d.toString();(p===`
`||p===`\r
`)&&(t=!0)}),!t)return!1;let s=Date.now();return s-this.lastEnterTime<kt.DOUBLE_ENTER_THRESHOLD?(this.lastEnterTime=0,this.clearPauseTimer(),this.onDoubleEnterTrigger&&this.onDoubleEnterTrigger(),!0):(this.lastEnterTime=s,!1)}clearPauseTimer(){this.pauseTimer&&(clearTimeout(this.pauseTimer),this.pauseTimer=null)}resetPauseTimer(){this.clearPauseTimer(),this.pauseTimer=setTimeout(()=>{this.enabled&&this.onPauseTrigger&&this.onPauseTrigger()},this.pauseDuration)}setContent(e){this.lastContent=e}hasNewContent(e){return e!==this.lastContent}markProcessed(e){this.lastContent=e}destroy(){this.clearPauseTimer(),this.onPauseTrigger=null,this.onDoubleEnterTrigger=null,this.enabled=!1}};kt.DOUBLE_ENTER_THRESHOLD=300;var vt=kt,Te=class Te{constructor(){this.analysisTimer=null;this.lastAnalyzedContent="";this.lastWhisperTime=0;this.onAnalyzeTrigger=null;this.enabled=!1}enable(){this.enabled=!0,this.startAnalysisLoop()}disable(){this.enabled=!1,this.stopAnalysisLoop()}isEnabled(){return this.enabled}onAnalyze(e){this.onAnalyzeTrigger=e}startAnalysisLoop(){this.stopAnalysisLoop(),this.analysisTimer=setInterval(()=>{this.enabled&&this.canWhisper()&&this.onAnalyzeTrigger&&this.onAnalyzeTrigger()},Te.ANALYSIS_INTERVAL)}stopAnalysisLoop(){this.analysisTimer&&(clearInterval(this.analysisTimer),this.analysisTimer=null)}canWhisper(){return Date.now()-this.lastWhisperTime>=Te.MIN_WHISPER_INTERVAL}hasSignificantChange(e){return e===this.lastAnalyzedContent?!1:Math.abs(e.length-this.lastAnalyzedContent.length)>=50}markAnalyzed(e){this.lastAnalyzedContent=e,this.lastWhisperTime=Date.now()}destroy(){this.stopAnalysisLoop(),this.onAnalyzeTrigger=null,this.enabled=!1}};Te.MIN_WHISPER_INTERVAL=3e4,Te.ANALYSIS_INTERVAL=5e3;var Pt=Te;var an=require("obsidian");function nn(r,e){let t=r.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter))return{};let s=t.frontmatter,n={};if(s["enchant-style"]){let i=s["enchant-style"].toLowerCase();(i==="muse"||i==="whisper")&&(n.style=i)}if(s["enchant-mood"]){let i=s["enchant-mood"].toLowerCase();(i==="reflect"||i==="think"||i==="plan")&&(n.mood=i)}return s.type&&(n.type=s.type.toLowerCase()),n}function rn(r){return{journal:"reflect",diary:"reflect",reflection:"reflect",essay:"think",writing:"think",article:"think",idea:"think",ideas:"think",project:"plan",todo:"plan",task:"plan",tasks:"plan",plan:"plan",planning:"plan"}[r.toLowerCase()]||null}var on={journal:"reflect",journals:"reflect",diary:"reflect",diaries:"reflect",reflection:"reflect",reflections:"reflect",project:"plan",projects:"plan",todo:"plan",todos:"plan",task:"plan",tasks:"plan",planning:"plan",essay:"think",essays:"think",writing:"think",writings:"think",idea:"think",ideas:"think",article:"think",articles:"think"},dr=[{pattern:/\bI feel\b/i,mood:"reflect"},{pattern:/\bI felt\b/i,mood:"reflect"},{pattern:/\bToday I\b/i,mood:"reflect"},{pattern:/\bI'm feeling\b/i,mood:"reflect"},{pattern:/\bI've been feeling\b/i,mood:"reflect"},{pattern:/\bI noticed\b/i,mood:"reflect"},{pattern:/\bI'm grateful\b/i,mood:"reflect"},{pattern:/\bI'm struggling\b/i,mood:"reflect"},{pattern:/^- \[ \]/m,mood:"plan"},{pattern:/^- \[x\]/im,mood:"plan"},{pattern:/\bTODO\b/i,mood:"plan"},{pattern:/\bnext steps\b/i,mood:"plan"},{pattern:/\baction items\b/i,mood:"plan"},{pattern:/\bdeadline\b/i,mood:"plan"},{pattern:/\bthe argument is\b/i,mood:"think"},{pattern:/\bmy thesis\b/i,mood:"think"},{pattern:/\bI argue\b/i,mood:"think"},{pattern:/\bI believe\b/i,mood:"think"},{pattern:/\bthe evidence\b/i,mood:"think"},{pattern:/\bthe reason\b/i,mood:"think"},{pattern:/\bin conclusion\b/i,mood:"think"},{pattern:/\bfurthermore\b/i,mood:"think"},{pattern:/\bhowever\b/i,mood:"think"}];function ur(r){let e=r.toLowerCase().split("/");for(let t of e)if(on[t])return on[t];return null}function hr(r){let e={reflect:0,think:0,plan:0};for(let{pattern:n,mood:i}of dr){let o=r.match(new RegExp(n,"g"));o&&(e[i]+=o.length)}let t=null,s=0;for(let[n,i]of Object.entries(e))i>s&&(s=i,t=n);return s>=2?t:null}function Tt(r,e,t,s){let n=nn(r,e);if(n.mood)return{mood:n.mood,style:n.style||(s.defaultStyle==="off"?"muse":s.defaultStyle),source:"frontmatter"};if(n.type){let a=rn(n.type);if(a)return{mood:a,style:n.style||(s.defaultStyle==="off"?"muse":s.defaultStyle),source:"frontmatter"}}let i=ur(e.path);if(i)return{mood:i,style:n.style||(s.defaultStyle==="off"?"muse":s.defaultStyle),source:"folder"};let o=hr(t);return o?{mood:o,style:n.style||(s.defaultStyle==="off"?"muse":s.defaultStyle),source:"content"}:{mood:s.defaultMood==="auto"?"reflect":s.defaultMood,style:s.defaultStyle==="off"?"muse":s.defaultStyle,source:"default"}}async function Ke(r,e,t,s=new Set){let n=[];if(t<=0||s.has(e.path))return n;s.add(e.path);let i=r.metadataCache.getFileCache(e);if(!(i!=null&&i.links))return n;for(let o of i.links){let a=r.metadataCache.getFirstLinkpathDest(o.link,e.path);if(a&&a instanceof an.TFile&&!s.has(a.path))try{let c=await r.vault.read(a);if(n.push(`--- ${a.basename} ---
${c}`),t>1){let d=await Ke(r,a,t-1,s);n.push(...d)}}catch(c){console.warn(`Couldn't read linked file: ${a.path}`)}}return n}var cs=/::muse\[(.*?)\]::/g,ds=/::whisper\[(.*?)\]::/g,us=/:::muse\n([\s\S]*?)\n:::/g,hs=/:::whisper\n([\s\S]*?)\n:::/g;function fr(r){let e=[],t;for(cs.lastIndex=0;(t=cs.exec(r))!==null;)e.push({type:"muse",content:t[1],isMultiline:!1,start:t.index,end:t.index+t[0].length});for(ds.lastIndex=0;(t=ds.exec(r))!==null;)e.push({type:"whisper",content:t[1],isMultiline:!1,start:t.index,end:t.index+t[0].length});for(us.lastIndex=0;(t=us.exec(r))!==null;)e.push({type:"muse",content:t[1],isMultiline:!0,start:t.index,end:t.index+t[0].length});for(hs.lastIndex=0;(t=hs.exec(r))!==null;)e.push({type:"whisper",content:t[1],isMultiline:!0,start:t.index,end:t.index+t[0].length});return e.sort((s,n)=>s.start-n.start),e}function fs(r){let e=r;return e=e.replace(us,""),e=e.replace(hs,""),e=e.replace(cs,""),e=e.replace(ds,""),e=e.replace(/\n{3,}/g,`

`),e}function ln(r,e){return fr(r).some(s=>e>=s.start&&e<=s.end)}function At(r){return fs(r).trim()}var ps=`You are a gentle, curious companion helping someone journal and reflect. Your role is to help them explore their feelings and thoughts more deeply.

Guidelines:
- Ask open-ended questions that invite introspection
- Reflect back what you notice without judgment
- Be warm and supportive
- Keep responses brief (1-2 sentences usually)
- Don't give advice unless explicitly asked
- Focus on feelings, not fixing

Example responses:
- "What does 'stuck' feel like in your body right now?"
- "You mentioned this happened before. What was different this time?"
- "There's something tender here. Want to stay with it?"`,ms=`You are observing someone's journaling and reflection. Offer brief, gentle observations as margin notes.

Guidelines:
- Notice patterns or themes without interrupting
- Point out emotions that might be worth exploring
- Keep observations to one short sentence
- Don't ask questions (that's for Muse mode)
- Only comment when there's something genuinely worth noting
- Be subtle and non-intrusive

Example observations:
- "This seems connected to what you wrote earlier about trust."
- "A shift in tone here."
- "You've circled back to this theme."`;var gs=`You are an intellectual sparring partner helping someone develop ideas. Your role is to strengthen their thinking by offering perspectives, challenges, and connections.

Guidelines:
- Suggest angles they haven't considered
- Point out assumptions worth questioning
- Offer counterarguments to strengthen their position
- Make connections to other ideas or fields
- Keep responses crisp and provocative
- Be intellectually honest, not just agreeable

Example responses:
- "This assumes X. What if that's not true?"
- "Steel-man the opposing view here\u2014what's the strongest case against this?"
- "This connects to [concept]. Have you considered that angle?"`,ys=`You are observing someone developing ideas and arguments. Offer brief, sharp observations as margin notes.

Guidelines:
- Spot logical gaps or unsupported claims
- Notice when an argument could be stronger
- Point out interesting connections
- Keep observations to one short sentence
- Don't ask questions (that's for Muse mode)
- Only comment when there's something genuinely useful to say
- Be intellectually rigorous but not dismissive

Example observations:
- "Bold claim. Evidence?"
- "You made this point in paragraph 2."
- "This contradicts your earlier assertion."
- "Counterexample: [brief mention]"`;var ws=`You are an execution-focused thinking partner helping someone plan and organize. Your role is to clarify, prioritize, and spot gaps.

Guidelines:
- Help break down vague intentions into concrete next actions
- Identify missing steps or dependencies
- Suggest prioritization when there are many items
- Flag potential blockers or risks
- Keep responses action-oriented
- Don't add unnecessary complexity

Example responses:
- "What's the very next physical action here?"
- "This depends on Y\u2014should that be a separate task?"
- "Three things here. Which one unblocks the others?"`,bs=`You are observing someone planning and organizing. Offer brief, practical observations as margin notes.

Guidelines:
- Spot missing dependencies or steps
- Notice when priorities aren't clear
- Point out potential blockers
- Keep observations to one short sentence
- Don't ask questions (that's for Muse mode)
- Only comment when there's something genuinely useful to say
- Be practical and action-oriented

Example observations:
- "This depends on the previous item."
- "Missing: who's responsible?"
- "This section is getting long."
- "Deadline not specified."`;function Rt(r,e){if(e==="whisper")switch(r){case"reflect":return ms;case"think":return ys;case"plan":return bs}switch(r){case"reflect":return ps;case"think":return gs;case"plan":return ws}}var Ct=class{constructor(e,t,s){this.isGenerating=!1;this.currentMood="auto";this.app=e,this.provider=t,this.settings=s,this.triggerManager=new vt(s.pauseDuration),this.setupTriggers()}setProvider(e){this.provider=e}setupTriggers(){this.triggerManager.onPause(()=>this.handleTrigger()),this.triggerManager.onDoubleEnter(()=>this.handleTrigger())}enable(){this.triggerManager.enable(),new Y.Notice("Muse mode enabled")}disable(){this.triggerManager.disable(),new Y.Notice("Muse mode disabled")}toggle(){this.triggerManager.isEnabled()?this.disable():this.enable()}isEnabled(){return this.triggerManager.isEnabled()}setMood(e){this.currentMood=e,new Y.Notice(`Mood set to: ${e==="auto"?"Auto-detect":e}`)}getMood(){return this.currentMood}updateSettings(e){this.settings=e,this.triggerManager.setPauseDuration(e.pauseDuration)}handleEditorUpdate(e){this.triggerManager.isEnabled()&&this.triggerManager.handleUpdate(e)}async summon(){await this.handleTrigger()}buildUserMessage(e){let t=At(e.noteContent),s="";return e.linkedNotes&&e.linkedNotes.length>0&&(s+=`## Linked Notes Context

`,s+=e.linkedNotes.join(`

`),s+=`

---

`),s+=`## Current Note

`,e.style==="muse"&&e.cursorPosition!==void 0?(s+=t.substring(0,e.cursorPosition),s+=`

[CURSOR POSITION - respond to what comes before this point]`):s+=t,s}async handleTrigger(){if(this.isGenerating)return;let e=this.app.workspace.getActiveViewOfType(Y.MarkdownView);if(!e)return;let t=e.file;if(!t)return;let s=e.editor,n=s.getValue(),i=s.getCursor(),o=s.posToOffset(i);if(!ln(n,o)&&this.triggerManager.hasNewContent(n)){if(!this.provider.isConfigured()){new Y.Notice("Please configure your LLM provider in settings");return}this.isGenerating=!0;try{let a=Tt(this.app,t,n,this.settings),c=this.currentMood!=="auto"?this.currentMood:a.mood,d={noteContent:n,cursorPosition:o,mood:c,style:"muse",notePath:t.path};this.settings.enableLinkedNoteContext&&(d.linkedNotes=await Ke(this.app,t,this.settings.linkedNoteDepth));let p=Rt(c,"muse"),m=this.buildUserMessage(d);s.replaceRange(`

::muse[...]::  `,s.offsetToPos(o));let y="";await this.provider.chat(p,m,h=>{y+=h;let _=s.getValue(),$=_.match(/::muse\[([^\]]*)\]::/);if($){let te=_.indexOf($[0]),ce=te+$[0].length;s.replaceRange(`::muse[${y}]::`,s.offsetToPos(te),s.offsetToPos(ce))}},h=>{this.triggerManager.markProcessed(s.getValue())})}catch(a){console.error("Muse generation error:",a),new Y.Notice(`Muse error: ${a instanceof Error?a.message:"Unknown error"}`);let c=s.getValue(),d=c.match(/::muse\[\.\.\.\]::/);if(d){let p=c.indexOf(d[0]),m=p+d[0].length;s.replaceRange("",s.offsetToPos(p),s.offsetToPos(m))}}finally{this.isGenerating=!1}}}getTriggerManager(){return this.triggerManager}destroy(){this.triggerManager.destroy()}};var le=require("obsidian");var Q=require("@codemirror/view"),Z=require("@codemirror/state"),cn=/::whisper\[(.*?)\]::/g,Ms=Z.StateEffect.define(),un=Z.StateEffect.define(),xs=Z.StateEffect.define(),hn=Z.StateField.define({create(){return[]},update(r,e){let t=r;for(let s of e.effects)s.is(Ms)?(t=t.filter(n=>n.line!==s.value.line),t=[...t,s.value]):s.is(un)?t=t.filter(n=>n.line!==s.value):s.is(xs)&&(t=[]);return e.docChanged&&(t=t.map(s=>{try{let n=e.startState.doc.line(Math.min(s.line,e.startState.doc.lines)),i=e.changes.mapPos(n.from),o=e.state.doc.lineAt(i);return{...s,line:o.number}}catch(n){return null}}).filter(s=>s!==null)),t}}),A=null;function q(){A&&(A.remove(),A=null)}var _s=class extends Q.WidgetType{constructor(t){super();this.content=t}toDOM(t){let s=document.createElement("span");return s.className="enchanted-whisper-icon",s.textContent="\u2728",s.setAttribute("aria-label","Whisper annotation"),s.setAttribute("role","button"),s.addEventListener("mouseenter",n=>{this.showPopover(s,t)}),s.addEventListener("mouseleave",n=>{setTimeout(()=>{A&&!A.matches(":hover")&&q()},100)}),s.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),A?q():this.showPopover(s,t)}),s}showPopover(t,s){q();let n=document.createElement("div");n.className="enchanted-whisper-popover",n.textContent=this.content;let i=t.getBoundingClientRect();n.style.position="fixed",n.style.top=`${i.bottom+4}px`,n.style.left=`${i.left}px`,n.addEventListener("mouseenter",()=>{}),n.addEventListener("mouseleave",()=>{q()}),document.body.appendChild(n),A=n;let o=n.getBoundingClientRect();o.right>window.innerWidth&&(n.style.left=`${window.innerWidth-o.width-10}px`),o.bottom>window.innerHeight&&(n.style.top=`${i.top-o.height-4}px`)}ignoreEvent(){return!1}},Ss=class extends Q.WidgetType{constructor(t,s){super();this.content=t;this.onDismiss=s}toDOM(t){let s=document.createElement("span");s.className="enchanted-whisper-inline-widget";let n=document.createElement("span");n.className="enchanted-whisper-icon",n.textContent="\u2728",n.addEventListener("mouseenter",()=>{this.showPopover(n)}),n.addEventListener("mouseleave",()=>{setTimeout(()=>{A&&!A.matches(":hover")&&q()},100)});let i=0;return n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();let a=Date.now();a-i<300?this.onDismiss():A?q():this.showPopover(n),i=a}),s.appendChild(n),s}showPopover(t){q();let s=document.createElement("div");s.className="enchanted-whisper-popover",s.textContent=this.content;let n=t.getBoundingClientRect();s.style.position="fixed",s.style.top=`${n.bottom+4}px`,s.style.left=`${n.left}px`,s.addEventListener("mouseleave",()=>{q()}),document.body.appendChild(s),A=s;let i=s.getBoundingClientRect();i.right>window.innerWidth&&(s.style.left=`${window.innerWidth-i.width-10}px`),i.bottom>window.innerHeight&&(s.style.top=`${n.top-i.height-4}px`)}ignoreEvent(){return!1}};function dn(r){let e=new Z.RangeSetBuilder,t=r.state.doc.toString();cn.lastIndex=0;let s;for(;(s=cn.exec(t))!==null;){let i=s.index,o=i+s[0].length,a=s[1];e.add(i,o,Q.Decoration.replace({widget:new Ss(a,()=>{r.dispatch({changes:{from:i,to:o,insert:""}})})}))}let n=r.state.field(hn,!1);if(n)for(let i of n)try{let o=r.state.doc.line(i.line);e.add(o.from,o.from,Q.Decoration.widget({widget:new _s(i.content),side:-1}))}catch(o){}return e.finish()}function fn(){return[hn,Q.ViewPlugin.fromClass(class{constructor(r){this.decorations=dn(r)}update(r){(r.docChanged||r.viewportChanged||r.transactions.some(e=>e.effects.some(t=>t.is(Ms)||t.is(un)||t.is(xs))))&&(this.decorations=dn(r.view))}},{decorations:r=>r.decorations})]}function pn(r,e,t){r.dispatch({effects:Ms.of({line:e,content:t})})}function mn(r){r.dispatch({effects:xs.of()})}document.addEventListener("click",r=>{A&&!A.contains(r.target)&&!r.target.classList.contains("enchanted-whisper-icon")&&q()});var Nt=class{constructor(e,t,s){this.isAnalyzing=!1;this.currentMood="auto";this.lastParagraphAnalyzed=-1;this.app=e,this.provider=t,this.settings=s,this.triggerManager=new Pt,this.setupTriggers()}setProvider(e){this.provider=e}setupTriggers(){this.triggerManager.onAnalyze(()=>this.handleAnalyze())}enable(){this.triggerManager.enable(),new le.Notice("Whisper mode enabled")}disable(){this.triggerManager.disable(),new le.Notice("Whisper mode disabled")}toggle(){this.triggerManager.isEnabled()?this.disable():this.enable()}isEnabled(){return this.triggerManager.isEnabled()}setMood(e){this.currentMood=e}updateSettings(e){this.settings=e}buildUserMessage(e){let t=At(e.noteContent),s="";return e.linkedNotes&&e.linkedNotes.length>0&&(s+=`## Linked Notes Context

`,s+=e.linkedNotes.join(`

`),s+=`

---

`),s+=`## Current Note

`,s+=t,s}async handleAnalyze(){if(this.isAnalyzing)return;let e=this.app.workspace.getActiveViewOfType(le.MarkdownView);if(!e)return;let t=e.file;if(!t)return;let n=e.editor.getValue();if(!this.triggerManager.hasSignificantChange(n)||!this.provider.isConfigured())return;let i=this.findParagraphToAnalyze(n);if(i!==null){this.isAnalyzing=!0;try{let o=Tt(this.app,t,n,this.settings),a=this.currentMood!=="auto"?this.currentMood:o.mood,c={noteContent:n,mood:a,style:"whisper",notePath:t.path};this.settings.enableLinkedNoteContext&&(c.linkedNotes=await Ke(this.app,t,this.settings.linkedNoteDepth));let d=Rt(a,"whisper")+`

IMPORTANT: Only respond if you have something genuinely useful to observe. If not, respond with exactly "NO_WHISPER" and nothing else.`,p=this.buildUserMessage(c),m=await this.provider.generate(d,p);if(m&&m!=="NO_WHISPER"&&!m.includes("NO_WHISPER")){let y=e.editor.cm;if(y){let h=this.getLineForParagraph(n,i);pn(y,h,m)}this.lastParagraphAnalyzed=i}this.triggerManager.markAnalyzed(n)}catch(o){console.error("Whisper analysis error:",o)}finally{this.isAnalyzing=!1}}}findParagraphToAnalyze(e){let t=e.split(/\n\n+/),s=[];for(let i=0;i<t.length;i++){let o=t[i].trim();o.length>50&&!o.startsWith("::muse[")&&!o.startsWith(":::muse")&&!o.startsWith("::whisper[")&&!o.startsWith("---")&&s.push(i)}if(s.length===0)return null;let n=s.filter(i=>i!==this.lastParagraphAnalyzed);return n.length===0?s[s.length-1]:n[n.length-1]}getLineForParagraph(e,t){let s=e.split(/\n\n+/),n=1;for(let i=0;i<t&&i<s.length;i++){let o=s[i].split(`
`).length;n+=o,n+=1}return n}clearWhispers(){let e=this.app.workspace.getActiveViewOfType(le.MarkdownView);if(!e)return;let t=e.editor.cm;t&&mn(t),new le.Notice("Whispers cleared")}destroy(){this.triggerManager.destroy()}};var I=require("obsidian");var B=require("@codemirror/view"),yn=require("@codemirror/state"),It=/::muse\[(.*?)\]::/g;var ee=new Set,Lt=class extends B.WidgetType{constructor(t,s,n){super();this.content=t;this.isMultiline=s;this.onDismiss=n}toDOM(){let t=document.createElement("span");t.className=this.isMultiline?"enchanted-muse-block":"enchanted-muse";let s=document.createElement("span");s.className="enchanted-muse-content",s.textContent=this.content,t.appendChild(s);let n=document.createElement("button");return n.className=this.isMultiline?"enchanted-muse-block-dismiss":"enchanted-muse-dismiss",n.textContent="\xD7",n.onclick=i=>{i.preventDefault(),i.stopPropagation(),this.onDismiss()},t.appendChild(n),t}ignoreEvent(){return!1}},Ot=class extends B.WidgetType{constructor(t){super();this.onReveal=t}toDOM(){let t=document.createElement("span");return t.className="enchanted-stowed",t.title="Click to reveal enchantment",t.onclick=s=>{s.preventDefault(),s.stopPropagation(),this.onReveal()},t}ignoreEvent(){return!1}};function gn(r,e=!1){let t=new yn.RangeSetBuilder,s=r.state.doc.toString();It.lastIndex=0;let n;for(;(n=It.exec(s))!==null;){let p=n.index,m=p+n[0].length,y=n[1];ee.has(p)&&!e?t.add(p,m,B.Decoration.replace({widget:new Ot(()=>{ee.delete(p),r.dispatch({effects:[]})})})):t.add(p,m,B.Decoration.replace({widget:new Lt(y,!1,()=>{r.dispatch({changes:{from:p,to:m,insert:""}})})}))}let i=s.split(`
`),o=0,a=!1,c=0,d="";for(let p=0;p<i.length;p++){let m=i[p],y=o,h=o+m.length;if(!a&&m.match(/^:::muse\s*$/))a=!0,c=y,d="";else if(a&&m.match(/^:::$/)){let _=h;ee.has(c)&&!e?t.add(c,_,B.Decoration.replace({widget:new Ot(()=>{ee.delete(c),r.dispatch({effects:[]})})})):t.add(c,_,B.Decoration.replace({widget:new Lt(d.trim(),!0,()=>{r.dispatch({changes:{from:c,to:_,insert:""}})})})),a=!1,d=""}else a&&(d+=(d?`
`:"")+m);o=h+1}return t.finish()}function wn(){return B.ViewPlugin.fromClass(class{constructor(r){this.decorations=gn(r)}update(r){(r.docChanged||r.viewportChanged)&&(this.decorations=gn(r.view))}},{decorations:r=>r.decorations})}function bn(r){let e=r.state.doc.toString();It.lastIndex=0;let t;for(;(t=It.exec(e))!==null;)ee.add(t.index);let s=e.split(`
`),n=0;for(let i=0;i<s.length;i++)s[i].match(/^:::muse\s*$/)&&ee.add(n),n+=s[i].length+1;r.dispatch({effects:[]})}function _n(r){ee.clear(),r.dispatch({effects:[]})}function Sn(){ee.clear()}function Mn(r,e,t,s){e({id:"toggle-muse",name:"Toggle Muse",hotkeys:[{modifiers:["Mod","Shift"],key:"m"}],callback:()=>{t.toggle()}}),e({id:"toggle-whisper",name:"Toggle Whisper",hotkeys:[{modifiers:["Mod","Shift"],key:"w"}],callback:()=>{s.toggle()}}),e({id:"stow-enchantments",name:"Stow Enchantments",checkCallback:n=>{let i=r.workspace.getActiveViewOfType(I.MarkdownView);if(!i)return!1;if(!n){let o=i.editor.cm;o&&(bn(o),new I.Notice("Enchantments stowed"))}return!0}}),e({id:"reveal-enchantments",name:"Reveal Enchantments",checkCallback:n=>{let i=r.workspace.getActiveViewOfType(I.MarkdownView);if(!i)return!1;if(!n){let o=i.editor.cm;o&&(_n(o),new I.Notice("Enchantments revealed"))}return!0}}),e({id:"banish-enchantments",name:"Banish Enchantments",checkCallback:n=>{let i=r.workspace.getActiveViewOfType(I.MarkdownView);if(!i)return!1;if(!n){let o=i.editor,a=o.getValue(),c=fs(a);a!==c?(o.setValue(c),new I.Notice("Enchantments banished")):new I.Notice("No enchantments to banish")}return!0}}),e({id:"set-mood-reflect",name:"Set Mood: Reflect",callback:()=>{t.setMood("reflect"),s.setMood("reflect")}}),e({id:"set-mood-think",name:"Set Mood: Think",callback:()=>{t.setMood("think"),s.setMood("think")}}),e({id:"set-mood-plan",name:"Set Mood: Plan",callback:()=>{t.setMood("plan"),s.setMood("plan")}}),e({id:"set-mood-auto",name:"Set Mood: Auto-detect",callback:()=>{t.setMood("auto"),s.setMood("auto")}}),e({id:"set-mood",name:"Set Mood",callback:()=>{var a;let n=[{mood:"auto",label:"Auto-detect"},{mood:"reflect",label:"Reflect (journaling)"},{mood:"think",label:"Think (essays/ideas)"},{mood:"plan",label:"Plan (todos/planning)"}],i=document.createElement("div");i.className="modal-container mod-dim",i.innerHTML=`
        <div class="modal-bg" style="opacity: 0.85;"></div>
        <div class="modal" style="width: 300px;">
          <div class="modal-title">Set Mood</div>
          <div class="modal-content" style="padding: 1em;">
            ${n.map((c,d)=>`
              <button class="mod-cta" style="width: 100%; margin-bottom: 0.5em;" data-mood="${c.mood}">
                ${c.label}
              </button>
            `).join("")}
          </div>
        </div>
      `,document.body.appendChild(i),i.querySelectorAll("button").forEach(c=>{c.addEventListener("click",()=>{let d=c.dataset.mood;t.setMood(d),s.setMood(d),i.remove()})}),(a=i.querySelector(".modal-bg"))==null||a.addEventListener("click",()=>{i.remove()});let o=c=>{c.key==="Escape"&&(i.remove(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)}}),e({id:"summon-muse",name:"Summon Muse",checkCallback:n=>r.workspace.getActiveViewOfType(I.MarkdownView)?(n||t.summon(),!0):!1}),e({id:"clear-whispers",name:"Clear Whispers",checkCallback:n=>r.workspace.getActiveViewOfType(I.MarkdownView)?(n||s.clearWhispers(),!0):!1})}var Dt=class extends xn.Plugin{constructor(){super(...arguments);this.settings=$t;this.provider=null;this.claudeProvider=null;this.ollamaProvider=null;this.museMode=null;this.whisperMode=null;this.editorExtensions=[]}async onload(){console.log("Loading Enchanted Notes plugin"),await this.loadSettings(),this.initializeProviders(),this.museMode=new Ct(this.app,this.provider,this.settings),this.whisperMode=new Nt(this.app,this.provider,this.settings),this.settings.defaultStyle==="muse"?this.museMode.enable():this.settings.defaultStyle==="whisper"&&this.whisperMode.enable(),Mn(this.app,t=>this.addCommand(t),this.museMode,this.whisperMode),this.addSettingTab(new xt(this.app,this)),this.registerEditorExtensions(),this.setupStatusBar()}initializeProviders(){this.claudeProvider=new Mt(this.settings.claudeApiKey,this.settings.claudeModel),this.ollamaProvider=new Et(this.settings.ollamaBaseUrl,this.settings.ollamaModel),this.provider=this.settings.provider==="claude"?this.claudeProvider:this.ollamaProvider}switchProvider(t){var s,n;this.provider=t==="claude"?this.claudeProvider:this.ollamaProvider,(s=this.museMode)==null||s.setProvider(this.provider),(n=this.whisperMode)==null||n.setProvider(this.provider)}updateProviderConfig(){this.settings.provider==="claude"&&this.claudeProvider?(this.claudeProvider.setApiKey(this.settings.claudeApiKey),this.claudeProvider.setModel(this.settings.claudeModel)):this.settings.provider==="ollama"&&this.ollamaProvider&&(this.ollamaProvider.setBaseUrl(this.settings.ollamaBaseUrl),this.ollamaProvider.setModel(this.settings.ollamaModel))}async testConnection(){return this.provider?this.provider.testConnection():!1}async fetchOllamaModels(){return this.ollamaProvider?this.ollamaProvider.listModels():[]}registerEditorExtensions(){let t=wn(),s=fn(),n=this.createTriggerPlugin();this.registerEditorExtension([t,s,n])}createTriggerPlugin(){let t=this.museMode;return En.ViewPlugin.fromClass(class{update(s){s.docChanged&&t&&t.handleEditorUpdate(s)}})}setupStatusBar(){let t=super.addStatusBarItem();t.addClass("enchanted-status");let s=()=>{var c,d;let n=((c=this.museMode)==null?void 0:c.isEnabled())||!1,i=((d=this.whisperMode)==null?void 0:d.isEnabled())||!1,o="",a="";n&&i?(o="Muse + Whisper",a="active"):n?(o="Muse",a="active"):i?(o="Whisper",a="whisper-active"):(o="Enchanted",a=""),t.empty(),t.createSpan({cls:`enchanted-status-indicator ${a}`}),t.createSpan({text:o})};this.registerInterval(window.setInterval(s,1e3)),s()}async onunload(){var t,s;console.log("Unloading Enchanted Notes plugin"),(t=this.museMode)==null||t.destroy(),(s=this.whisperMode)==null||s.destroy(),Sn()}async loadSettings(){this.settings=Object.assign({},$t,await this.loadData())}async saveSettings(){var t,s;await this.saveData(this.settings),(t=this.museMode)==null||t.updateSettings(this.settings),(s=this.whisperMode)==null||s.updateSettings(this.settings)}updatePauseDuration(t){var s;(s=this.museMode)==null||s.updateSettings({...this.settings,pauseDuration:t})}getStats(){var t;return((t=this.provider)==null?void 0:t.getStats())||{tokensThisSession:0,tokensToday:0,lastResponseTime:0,currentContextSize:0}}resetSessionStats(){var t;(t=this.provider)==null||t.resetSessionStats()}};
